"""Restructure pipeline to accomodate more flesible computational graph

Revision ID: 630fe1806d12
Revises: 66a9f61aa0cf
Create Date: 2025-09-26 17:46:44.483158

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = '630fe1806d12'
down_revision: Union[str, None] = '66a9f61aa0cf'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('function_input_object_group_desc',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('function_id', sa.UUID(), nullable=False),
                    sa.Column('structure_id', sa.String(), nullable=False),
                    sa.Column('name', sa.String(), nullable=False),
                    sa.Column('description', sa.String(), nullable=True),
                    sa.Column('required', sa.Boolean(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.CheckConstraint(
                        "structure_id IN ('time_series', 'time_series_aggregation')"),
                    sa.ForeignKeyConstraint(
                        ['function_id'], ['function.function.id'], ),
                    sa.PrimaryKeyConstraint('id'),
                    schema='function'
                    )
    op.create_table('function_output_object_group_desc',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('name', sa.String(), nullable=False),
                    sa.Column('function_id', sa.UUID(), nullable=False),
                    sa.Column('structure_id', sa.String(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('description', sa.String(), nullable=True),
                    sa.CheckConstraint(
                        "structure_id IN ('time_series', 'time_series_aggregation')"),
                    sa.ForeignKeyConstraint(
                        ['function_id'], ['function.function.id'], ),
                    sa.PrimaryKeyConstraint('id'),
                    schema='function'
                    )
    op.create_table('function_output_variable_desc',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('name', sa.String(), nullable=False),
                    sa.Column('function_id', sa.UUID(), nullable=False),
                    sa.Column('python_type', sa.String(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('description', sa.String(), nullable=True),
                    sa.ForeignKeyConstraint(
                        ['function_id'], ['function.function.id'], ),
                    sa.PrimaryKeyConstraint('id'),
                    schema='function'
                    )
    op.create_table('function_in_pipeline_object_group_mapping',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('pipeline_id', sa.UUID(), nullable=False),
                    sa.Column('from_function_id', sa.UUID(), nullable=True),
                    sa.Column('to_function_id', sa.UUID(), nullable=False),
                    sa.Column('from_function_output_object_group',
                              sa.UUID(), nullable=True),
                    sa.Column('to_function_input_object_group',
                              sa.UUID(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(['from_function_id'], [
                        'function.function.id'], ),
                    sa.ForeignKeyConstraint(['from_function_output_object_group'], [
                        'function.function_output_object_group_desc.id'], ),
                    sa.ForeignKeyConstraint(
                        ['pipeline_id'], ['pipeline.pipeline.id'], ),
                    sa.ForeignKeyConstraint(['to_function_id'], [
                        'function.function.id'], ),
                    sa.ForeignKeyConstraint(['to_function_input_object_group'], [
                        'function.function_input_object_group_desc.id'], ),
                    sa.PrimaryKeyConstraint('id'),
                    schema='pipeline'
                    )
    op.create_table('pipeline_output_dataset',
                    sa.Column('pipeline_id', sa.UUID(), nullable=False),
                    sa.Column('dataset_id', sa.UUID(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(
                        ['dataset_id'], ['data_objects.dataset.id'], ),
                    sa.ForeignKeyConstraint(
                        ['pipeline_id'], ['pipeline.pipeline.id'], ),
                    sa.PrimaryKeyConstraint('pipeline_id', 'dataset_id'),
                    schema='pipeline'
                    )
    op.create_table('pipeline_run_variable_group_result',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('pipeline_run_id', sa.UUID(), nullable=False),
                    sa.Column('variable_group_id', sa.UUID(), nullable=False),
                    sa.Column('source_function_id', sa.UUID(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(['pipeline_run_id'], [
                        'pipeline.pipeline_run.id'], ),
                    sa.ForeignKeyConstraint(['source_function_id'], [
                        'function.function.id'], ),
                    sa.ForeignKeyConstraint(['variable_group_id'], [
                        'data_objects.variable_group.id'], ),
                    sa.PrimaryKeyConstraint('id'),
                    schema='pipeline'
                    )
    op.drop_table('function_output_structure', schema='function')
    op.drop_table('pipeline_run_variables_result', schema='pipeline')
    op.drop_table('function_input_structure', schema='function')
    op.drop_table('function_output_variable', schema='function')
    op.add_column('function_in_pipeline', sa.Column('model_config', postgresql.JSONB(
        astext_type=sa.Text()), nullable=True), schema='pipeline')
    op.drop_column('function_in_pipeline', 'position', schema='pipeline')
    op.add_column('pipeline_run_object_group_result', sa.Column(
        'source_function_id', sa.UUID(), nullable=False), schema='pipeline')
    op.create_foreign_key(None, 'pipeline_run_object_group_result', 'function', [
                          'source_function_id'], ['id'], source_schema='pipeline', referent_schema='function')
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint(None, 'pipeline_run_object_group_result',
                       schema='pipeline', type_='foreignkey')
    op.drop_column('pipeline_run_object_group_result',
                   'source_function_id', schema='pipeline')
    op.add_column('function_in_pipeline', sa.Column(
        'position', sa.INTEGER(), autoincrement=False, nullable=False), schema='pipeline')
    op.drop_column('function_in_pipeline', 'model_config', schema='pipeline')
    op.create_table('function_output_variable',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('name', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('function_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('python_type', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('description', sa.VARCHAR(),
                              autoincrement=False, nullable=True),
                    sa.ForeignKeyConstraint(['function_id'], ['function.function.id'], name=op.f(
                        'function_output_variable_function_id_fkey')),
                    sa.PrimaryKeyConstraint('id', name=op.f(
                        'function_output_variable_pkey')),
                    schema='function'
                    )
    op.create_table('function_input_structure',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('function_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('structure_id', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('name', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('description', sa.VARCHAR(),
                              autoincrement=False, nullable=True),
                    sa.Column('required', sa.BOOLEAN(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.CheckConstraint("structure_id::text = ANY (ARRAY['time_series'::character varying, 'time_series_aggregation'::character varying]::text[])", name=op.f(
                        'function_input_structure_structure_id_check')),
                    sa.ForeignKeyConstraint(['function_id'], ['function.function.id'], name=op.f(
                        'function_input_structure_function_id_fkey')),
                    sa.PrimaryKeyConstraint('id', name=op.f(
                        'function_input_structure_pkey')),
                    schema='function'
                    )
    op.create_table('pipeline_run_variables_result',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('pipeline_run_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('variables_save_path', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.ForeignKeyConstraint(['pipeline_run_id'], ['pipeline.pipeline_run.id'], name=op.f(
                        'pipeline_run_variables_result_pipeline_run_id_fkey')),
                    sa.PrimaryKeyConstraint('id', name=op.f(
                        'pipeline_run_variables_result_pkey')),
                    schema='pipeline'
                    )
    op.create_table('function_output_structure',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('name', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('function_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('structure_id', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('description', sa.VARCHAR(),
                              autoincrement=False, nullable=True),
                    sa.CheckConstraint("structure_id::text = ANY (ARRAY['time_series'::character varying, 'time_series_aggregation'::character varying]::text[])", name=op.f(
                        'function_output_structure_structure_id_check')),
                    sa.ForeignKeyConstraint(['function_id'], ['function.function.id'], name=op.f(
                        'function_output_structure_function_id_fkey')),
                    sa.PrimaryKeyConstraint('id', name=op.f(
                        'function_output_structure_pkey')),
                    schema='function'
                    )
    op.drop_table('pipeline_run_variable_group_result', schema='pipeline')
    op.drop_table('pipeline_output_dataset', schema='pipeline')
    op.drop_table('function_in_pipeline_object_group_mapping',
                  schema='pipeline')
    op.drop_table('function_output_variable_desc', schema='function')
    op.drop_table('function_output_object_group_desc', schema='function')
    op.drop_table('function_input_object_group_desc', schema='function')
    # ### end Alembic commands ###
