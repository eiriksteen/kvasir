"""Add models to run pipelines

Revision ID: d7ea92878fd3
Revises: 968919c78730
Create Date: 2025-09-29 22:27:41.201799

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = 'd7ea92878fd3'
down_revision: Union[str, None] = '968919c78730'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('function_definition',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('name', sa.String(), nullable=False),
                    sa.Column('type', sa.String(), nullable=False),
                    sa.Column('args_dataclass_name',
                              sa.String(), nullable=False),
                    sa.Column('input_dataclass_name',
                              sa.String(), nullable=False),
                    sa.Column('output_dataclass_name',
                              sa.String(), nullable=False),
                    sa.Column('output_variables_dataclass_name',
                              sa.String(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.CheckConstraint(
                        "type IN ('inference', 'training', 'computation', 'tool')"),
                    sa.PrimaryKeyConstraint('id'),
                    sa.UniqueConstraint('name'),
                    schema='function'
                    )
    op.create_table('function_input_object_group_definition',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('function_id', sa.UUID(), nullable=False),
                    sa.Column('structure_id', sa.String(), nullable=False),
                    sa.Column('name', sa.String(), nullable=False),
                    sa.Column('description', sa.String(), nullable=True),
                    sa.Column('required', sa.Boolean(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.CheckConstraint(
                        "structure_id IN ('time_series', 'time_series_aggregation')"),
                    sa.ForeignKeyConstraint(
                        ['function_id'], ['function.function.id'], ),
                    sa.PrimaryKeyConstraint('id'),
                    schema='function'
                    )
    op.create_table('function_output_object_group_definition',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('name', sa.String(), nullable=False),
                    sa.Column('function_id', sa.UUID(), nullable=False),
                    sa.Column('structure_id', sa.String(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('description', sa.String(), nullable=True),
                    sa.CheckConstraint(
                        "structure_id IN ('time_series', 'time_series_aggregation')"),
                    sa.ForeignKeyConstraint(
                        ['function_id'], ['function.function.id'], ),
                    sa.PrimaryKeyConstraint('id'),
                    schema='function'
                    )
    op.create_table('function_output_variable_definition',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('name', sa.String(), nullable=False),
                    sa.Column('function_id', sa.UUID(), nullable=False),
                    sa.Column('python_type', sa.String(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('description', sa.String(), nullable=True),
                    sa.ForeignKeyConstraint(
                        ['function_id'], ['function.function.id'], ),
                    sa.PrimaryKeyConstraint('id'),
                    schema='function'
                    )
    op.add_column('function', sa.Column(
        'version', sa.Integer(), nullable=False), schema='function')
    op.drop_column('function', 'type', schema='function')
    op.drop_column('function', 'output_variables_dataclass_name',
                   schema='function')
    op.drop_column('function', 'input_dataclass_name', schema='function')
    op.drop_column('function', 'output_dataclass_name', schema='function')
    op.drop_column('function', 'args_dataclass_name', schema='function')
    op.drop_column('function', 'name', schema='function')
    op.drop_constraint(op.f('function_in_pipeline_object_g_to_function_input_object_gro_fkey'),
                       'function_in_pipeline_object_group_mapping', schema='pipeline', type_='foreignkey')
    op.drop_constraint(op.f('function_in_pipeline_object_g_from_function_output_object__fkey'),
                       'function_in_pipeline_object_group_mapping', schema='pipeline', type_='foreignkey')
    op.create_foreign_key(None, 'function_in_pipeline_object_group_mapping', 'function_output_object_group_definition', [
                          'from_function_output_object_group_id'], ['id'], source_schema='pipeline', referent_schema='function')
    op.create_foreign_key(None, 'function_in_pipeline_object_group_mapping', 'function_input_object_group_definition', [
                          'to_function_input_object_group_id'], ['id'], source_schema='pipeline', referent_schema='function')
    op.add_column('pipeline', sa.Column('implementation_script_path',
                  sa.String(), nullable=False), schema='pipeline')
    op.drop_constraint(op.f('pipeline_object_group_output_to_save_object_group_desc_id_fkey'),
                       'pipeline_object_group_output_to_save', schema='pipeline', type_='foreignkey')
    op.create_foreign_key(None, 'pipeline_object_group_output_to_save', 'function_output_object_group_definition', [
                          'object_group_desc_id'], ['id'], source_schema='pipeline', referent_schema='function')
    op.drop_constraint(op.f('pipeline_variable_group_output_to_s_variable_group_desc_id_fkey'),
                       'pipeline_variable_group_output_to_save', schema='pipeline', type_='foreignkey')
    op.create_foreign_key(None, 'pipeline_variable_group_output_to_save', 'function_output_variable_definition', [
                          'variable_group_desc_id'], ['id'], source_schema='pipeline', referent_schema='function')
    op.execute(
        "DROP TABLE IF EXISTS function.function_output_object_group_desc CASCADE")
    op.execute(
        "DROP TABLE IF EXISTS function.function_input_object_group_desc CASCADE")
    op.execute(
        "DROP TABLE IF EXISTS function.function_output_variable_desc CASCADE")
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint(None, 'pipeline_variable_group_output_to_save',
                       schema='pipeline', type_='foreignkey')
    op.create_foreign_key(op.f('pipeline_variable_group_output_to_s_variable_group_desc_id_fkey'), 'pipeline_variable_group_output_to_save',
                          'function_output_variable_desc', ['variable_group_desc_id'], ['id'], source_schema='pipeline', referent_schema='function')
    op.drop_constraint(None, 'pipeline_object_group_output_to_save',
                       schema='pipeline', type_='foreignkey')
    op.create_foreign_key(op.f('pipeline_object_group_output_to_save_object_group_desc_id_fkey'), 'pipeline_object_group_output_to_save',
                          'function_output_object_group_desc', ['object_group_desc_id'], ['id'], source_schema='pipeline', referent_schema='function')
    op.drop_column('pipeline', 'implementation_script_path', schema='pipeline')
    op.drop_constraint(None, 'function_in_pipeline_object_group_mapping',
                       schema='pipeline', type_='foreignkey')
    op.drop_constraint(None, 'function_in_pipeline_object_group_mapping',
                       schema='pipeline', type_='foreignkey')
    op.create_foreign_key(op.f('function_in_pipeline_object_g_from_function_output_object__fkey'), 'function_in_pipeline_object_group_mapping',
                          'function_output_object_group_desc', ['from_function_output_object_group_id'], ['id'], source_schema='pipeline', referent_schema='function')
    op.create_foreign_key(op.f('function_in_pipeline_object_g_to_function_input_object_gro_fkey'), 'function_in_pipeline_object_group_mapping',
                          'function_input_object_group_desc', ['to_function_input_object_group_id'], ['id'], source_schema='pipeline', referent_schema='function')
    op.add_column('function', sa.Column('name', sa.VARCHAR(),
                  autoincrement=False, nullable=False), schema='function')
    op.add_column('function', sa.Column('args_dataclass_name', sa.VARCHAR(
    ), autoincrement=False, nullable=False), schema='function')
    op.add_column('function', sa.Column('output_dataclass_name', sa.VARCHAR(
    ), autoincrement=False, nullable=False), schema='function')
    op.add_column('function', sa.Column('input_dataclass_name', sa.VARCHAR(
    ), autoincrement=False, nullable=False), schema='function')
    op.add_column('function', sa.Column('output_variables_dataclass_name',
                  sa.VARCHAR(), autoincrement=False, nullable=False), schema='function')
    op.add_column('function', sa.Column('type', sa.VARCHAR(),
                  autoincrement=False, nullable=False), schema='function')
    op.drop_column('function', 'version', schema='function')
    op.create_table('function_output_variable_desc',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('name', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('function_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('python_type', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('description', sa.VARCHAR(),
                              autoincrement=False, nullable=True),
                    sa.ForeignKeyConstraint(['function_id'], ['function.function.id'], name=op.f(
                        'function_output_variable_desc_function_id_fkey')),
                    sa.PrimaryKeyConstraint('id', name=op.f(
                        'function_output_variable_desc_pkey')),
                    schema='function'
                    )
    op.create_table('function_input_object_group_desc',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('function_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('structure_id', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('name', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('description', sa.VARCHAR(),
                              autoincrement=False, nullable=True),
                    sa.Column('required', sa.BOOLEAN(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.CheckConstraint("structure_id::text = ANY (ARRAY['time_series'::character varying, 'time_series_aggregation'::character varying]::text[])", name=op.f(
                        'function_input_object_group_desc_structure_id_check')),
                    sa.ForeignKeyConstraint(['function_id'], ['function.function.id'], name=op.f(
                        'function_input_object_group_desc_function_id_fkey')),
                    sa.PrimaryKeyConstraint('id', name=op.f(
                        'function_input_object_group_desc_pkey')),
                    schema='function'
                    )
    op.create_table('function_output_object_group_desc',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('name', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('function_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('structure_id', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('description', sa.VARCHAR(),
                              autoincrement=False, nullable=True),
                    sa.CheckConstraint("structure_id::text = ANY (ARRAY['time_series'::character varying, 'time_series_aggregation'::character varying]::text[])", name=op.f(
                        'function_output_object_group_desc_structure_id_check')),
                    sa.ForeignKeyConstraint(['function_id'], ['function.function.id'], name=op.f(
                        'function_output_object_group_desc_function_id_fkey')),
                    sa.PrimaryKeyConstraint('id', name=op.f(
                        'function_output_object_group_desc_pkey')),
                    schema='function'
                    )
    op.drop_table('function_output_variable_definition', schema='function')
    op.drop_table('function_output_object_group_definition', schema='function')
    op.drop_table('function_input_object_group_definition', schema='function')
    op.drop_table('function_definition', schema='function')
    # ### end Alembic commands ###
