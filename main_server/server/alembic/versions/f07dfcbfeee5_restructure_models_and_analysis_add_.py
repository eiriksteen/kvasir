"""Restructure models and analysis, add node models to entity graph

Revision ID: f07dfcbfeee5
Revises: a220fe0ba734
Create Date: 2025-11-18 00:17:14.841310

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = 'f07dfcbfeee5'
down_revision: Union[str, None] = 'a220fe0ba734'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    # Create schemas
    op.execute('CREATE SCHEMA IF NOT EXISTS kvasir_v1')

    op.create_table('entity_node',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('name', sa.String(), nullable=False),
                    sa.Column('x_position', sa.Float(), nullable=False),
                    sa.Column('y_position', sa.Float(), nullable=False),
                    sa.Column('entity_type', sa.String(), nullable=False),
                    sa.Column('description', sa.String(), nullable=True),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.PrimaryKeyConstraint('id', name=op.f('pk_entity_node')),
                    schema='entity_graph'
                    )
    op.create_table('node_group',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('name', sa.String(), nullable=False),
                    sa.Column('description', sa.String(), nullable=True),
                    sa.Column('python_package_name',
                              sa.String(), nullable=True),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.PrimaryKeyConstraint('id', name=op.f('pk_node_group')),
                    schema='entity_graph'
                    )
    op.create_table('node_in_group',
                    sa.Column('node_id', sa.UUID(), nullable=False),
                    sa.Column('node_group_id', sa.UUID(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(['node_group_id'], ['entity_graph.node_group.id'], name=op.f(
                        'fk_node_in_group_node_group_id_node_group')),
                    sa.ForeignKeyConstraint(['node_id'], ['entity_graph.entity_node.id'], name=op.f(
                        'fk_node_in_group_node_id_entity_node')),
                    sa.PrimaryKeyConstraint(
                        'node_id', 'node_group_id', name=op.f('pk_node_in_group')),
                    schema='entity_graph'
                    )
    op.create_table('model',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('name', sa.String(), nullable=False),
                    sa.Column('user_id', sa.UUID(), nullable=False),
                    sa.Column('description', sa.String(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(
                        ['user_id'], ['auth.users.id'], name=op.f('fk_model_user_id_users')),
                    sa.PrimaryKeyConstraint('id', name=op.f('pk_model')),
                    schema='model'
                    )
    op.create_table('analysis_section',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('name', sa.String(), nullable=False),
                    sa.Column('analysis_id', sa.UUID(), nullable=False),
                    sa.Column('description', sa.String(), nullable=True),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(['analysis_id'], ['analysis.analysis.id'], name=op.f(
                        'fk_analysis_section_analysis_id_analysis')),
                    sa.PrimaryKeyConstraint(
                        'id', name=op.f('pk_analysis_section')),
                    schema='analysis'
                    )
    op.create_table('model_instantiated',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('model_id', sa.UUID(), nullable=False),
                    sa.Column('name', sa.String(), nullable=False),
                    sa.Column('user_id', sa.UUID(), nullable=False),
                    sa.Column('description', sa.String(), nullable=False),
                    sa.Column('config', postgresql.JSONB(
                        astext_type=sa.Text()), nullable=False),
                    sa.Column('weights_save_dir', sa.String(), nullable=True),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(['model_id'], ['model.model.id'], name=op.f(
                        'fk_model_instantiated_model_id_model')),
                    sa.ForeignKeyConstraint(['user_id'], ['auth.users.id'], name=op.f(
                        'fk_model_instantiated_user_id_users')),
                    sa.PrimaryKeyConstraint(
                        'id', name=op.f('pk_model_instantiated')),
                    schema='model'
                    )
    op.create_table('analysis_cell',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('order', sa.Integer(), nullable=False),
                    sa.Column('type', sa.String(), nullable=False),
                    sa.Column('section_id', sa.UUID(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.CheckConstraint("type IN ('markdown', 'code')",
                                       name='analysis_cell_type_check'),
                    sa.ForeignKeyConstraint(['section_id'], ['analysis.analysis_section.id'], name=op.f(
                        'fk_analysis_cell_section_id_analysis_section')),
                    sa.PrimaryKeyConstraint(
                        'id', name=op.f('pk_analysis_cell')),
                    schema='analysis'
                    )
    op.create_table('model_instantiated_in_analysis',
                    sa.Column('analysis_id', sa.UUID(), nullable=False),
                    sa.Column('model_instantiated_id',
                              sa.UUID(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(['analysis_id'], ['analysis.analysis.id'], name=op.f(
                        'fk_model_instantiated_in_analysis_analysis_id_analysis')),
                    sa.ForeignKeyConstraint(['model_instantiated_id'], ['model.model_instantiated.id'], name=op.f(
                        'fk_model_instantiated_in_analysis_model_instantiated_id_model_instantiated')),
                    sa.PrimaryKeyConstraint('analysis_id', 'model_instantiated_id', name=op.f(
                        'pk_model_instantiated_in_analysis')),
                    schema='entity_graph'
                    )
    op.create_table('model_instantiated_in_pipeline_run',
                    sa.Column('pipeline_run_id', sa.UUID(), nullable=False),
                    sa.Column('model_instantiated_id',
                              sa.UUID(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(['model_instantiated_id'], ['model.model_instantiated.id'], name=op.f(
                        'fk_model_instantiated_in_pipeline_run_model_instantiated_id_model_instantiated')),
                    sa.ForeignKeyConstraint(['pipeline_run_id'], ['pipeline.pipeline_run.id'], name=op.f(
                        'fk_model_instantiated_in_pipeline_run_pipeline_run_id_pipeline_run')),
                    sa.PrimaryKeyConstraint('pipeline_run_id', 'model_instantiated_id', name=op.f(
                        'pk_model_instantiated_in_pipeline_run')),
                    schema='entity_graph'
                    )
    op.create_table('model_instantiated_supported_in_pipeline',
                    sa.Column('model_instantiated_id',
                              sa.UUID(), nullable=False),
                    sa.Column('pipeline_id', sa.UUID(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(['model_instantiated_id'], ['model.model_instantiated.id'], name=op.f(
                        'fk_model_instantiated_supported_in_pipeline_model_instantiated_id_model_instantiated')),
                    sa.ForeignKeyConstraint(['pipeline_id'], ['pipeline.pipeline.id'], name=op.f(
                        'fk_model_instantiated_supported_in_pipeline_pipeline_id_pipeline')),
                    sa.PrimaryKeyConstraint('model_instantiated_id', 'pipeline_id', name=op.f(
                        'pk_model_instantiated_supported_in_pipeline')),
                    schema='entity_graph'
                    )
    op.create_table('pydantic_ai_message',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('run_id', sa.UUID(), nullable=False),
                    sa.Column('message_list', postgresql.BYTEA(),
                              nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(['run_id'], ['runs.run.id'], name=op.f(
                        'fk_pydantic_ai_message_run_id_run')),
                    sa.PrimaryKeyConstraint(
                        'id', name=op.f('pk_pydantic_ai_message')),
                    schema='kvasir_v1'
                    )
    op.create_table('result',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('run_id', sa.UUID(), nullable=False),
                    sa.Column('type', sa.String(), nullable=False),
                    sa.Column('content', sa.String(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(
                        ['run_id'], ['runs.run.id'], name=op.f('fk_result_run_id_run')),
                    sa.PrimaryKeyConstraint('id', name=op.f('pk_result')),
                    schema='kvasir_v1'
                    )
    op.create_table('results_queue',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('run_id', sa.UUID(), nullable=False),
                    sa.Column('content', postgresql.JSONB(
                        astext_type=sa.Text()), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(['run_id'], ['runs.run.id'], name=op.f(
                        'fk_results_queue_run_id_run')),
                    sa.PrimaryKeyConstraint(
                        'id', name=op.f('pk_results_queue')),
                    schema='kvasir_v1'
                    )
    op.create_table('swe_deps',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('run_id', sa.UUID(), nullable=False),
                    sa.Column('type', sa.String(), nullable=False),
                    sa.Column('content', sa.String(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(
                        ['run_id'], ['runs.run.id'], name=op.f('fk_swe_deps_run_id_run')),
                    sa.PrimaryKeyConstraint('id', name=op.f('pk_swe_deps')),
                    schema='kvasir_v1'
                    )
    op.create_table('model_instantiated_context',
                    sa.Column('context_id', sa.UUID(), nullable=False),
                    sa.Column('model_instantiated_id',
                              sa.UUID(), nullable=False),
                    sa.ForeignKeyConstraint(['context_id'], ['orchestrator.chat_context.id'], name=op.f(
                        'fk_model_instantiated_context_context_id_chat_context')),
                    sa.ForeignKeyConstraint(['model_instantiated_id'], ['model.model_instantiated.id'], name=op.f(
                        'fk_model_instantiated_context_model_instantiated_id_model_instantiated')),
                    sa.PrimaryKeyConstraint('context_id', 'model_instantiated_id', name=op.f(
                        'pk_model_instantiated_context')),
                    schema='orchestrator'
                    )
    op.create_table('model_instantiated_from_run',
                    sa.Column('run_id', sa.UUID(), nullable=False),
                    sa.Column('model_instantiated_id',
                              sa.UUID(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(['model_instantiated_id'], ['model.model_instantiated.id'], name=op.f(
                        'fk_model_instantiated_from_run_model_instantiated_id_model_instantiated')),
                    sa.ForeignKeyConstraint(['run_id'], ['runs.run.id'], name=op.f(
                        'fk_model_instantiated_from_run_run_id_run')),
                    sa.PrimaryKeyConstraint('run_id', 'model_instantiated_id', name=op.f(
                        'pk_model_instantiated_from_run')),
                    schema='runs'
                    )
    op.create_table('model_instantiated_in_run',
                    sa.Column('run_id', sa.UUID(), nullable=False),
                    sa.Column('model_instantiated_id',
                              sa.UUID(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(['model_instantiated_id'], ['model.model_instantiated.id'], name=op.f(
                        'fk_model_instantiated_in_run_model_instantiated_id_model_instantiated')),
                    sa.ForeignKeyConstraint(['run_id'], ['runs.run.id'], name=op.f(
                        'fk_model_instantiated_in_run_run_id_run')),
                    sa.PrimaryKeyConstraint('run_id', 'model_instantiated_id', name=op.f(
                        'pk_model_instantiated_in_run')),
                    schema='runs'
                    )
    op.create_table('code_cell',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('code', sa.String(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(['id'], ['analysis.analysis_cell.id'], name=op.f(
                        'fk_code_cell_id_analysis_cell')),
                    sa.PrimaryKeyConstraint('id', name=op.f('pk_code_cell')),
                    schema='analysis'
                    )
    op.create_table('markdown_cell',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('markdown', sa.String(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(['id'], ['analysis.analysis_cell.id'], name=op.f(
                        'fk_markdown_cell_id_analysis_cell')),
                    sa.PrimaryKeyConstraint(
                        'id', name=op.f('pk_markdown_cell')),
                    schema='analysis'
                    )
    op.create_table('code_output',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('output', sa.String(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(['id'], ['analysis.code_cell.id'], name=op.f(
                        'fk_code_output_id_code_cell')),
                    sa.PrimaryKeyConstraint('id', name=op.f('pk_code_output')),
                    schema='analysis'
                    )
    op.execute('DROP TABLE IF EXISTS model.model_definition CASCADE')
    op.execute('DROP TABLE IF EXISTS runs.model_entity_from_run CASCADE')
    op.execute('DROP TABLE IF EXISTS model.pypi_model_source CASCADE')
    op.execute(
        'DROP TABLE IF EXISTS entity_graph.model_entity_supported_in_pipeline CASCADE')
    op.execute('DROP TABLE IF EXISTS model.model_entity CASCADE')
    op.execute('DROP TABLE IF EXISTS orchestrator.model_entity_context CASCADE')
    op.execute('DROP TABLE IF EXISTS analysis.notebook CASCADE')
    op.execute(
        'DROP TABLE IF EXISTS entity_graph.model_entity_in_analysis CASCADE')
    op.execute('DROP TABLE IF EXISTS analysis.analysis_status_message CASCADE')
    op.execute('DROP TABLE IF EXISTS analysis.analysis_result CASCADE')
    op.execute('DROP TABLE IF EXISTS analysis.notebook_section CASCADE')
    op.execute('DROP TABLE IF EXISTS model.model_entity_implementation CASCADE')
    op.execute(
        'DROP TABLE IF EXISTS entity_graph.model_entity_in_pipeline_run CASCADE')
    op.execute('DROP TABLE IF EXISTS runs.model_entity_in_run CASCADE')
    op.execute('DROP TABLE IF EXISTS pipeline.function_in_pipeline CASCADE')
    op.execute('DROP TABLE IF EXISTS orchestrator.chat_pydantic_message CASCADE')
    op.execute('DROP TABLE IF EXISTS model.model_source CASCADE')
    op.add_column('analysis', sa.Column('updated_at', sa.DateTime(
        timezone=True), nullable=False), schema='analysis')
    op.drop_column('analysis', 'notebook_id', schema='analysis')
    op.drop_column('analysis', 'report_generated', schema='analysis')
    op.add_column('result_echart', sa.Column('code_cell_id',
                  sa.UUID(), nullable=False), schema='analysis')
    op.add_column('result_echart', sa.Column('created_at', sa.DateTime(
        timezone=True), nullable=False), schema='analysis')
    op.add_column('result_echart', sa.Column('updated_at', sa.DateTime(
        timezone=True), nullable=False), schema='analysis')
    op.execute('ALTER TABLE analysis.result_echart DROP CONSTRAINT IF EXISTS fk_result_echart_analysis_result_id_analysis_result')
    op.create_foreign_key(op.f('fk_result_echart_code_cell_id_code_cell'), 'result_echart', 'code_cell', [
                          'code_cell_id'], ['id'], source_schema='analysis', referent_schema='analysis')
    op.execute(
        'ALTER TABLE analysis.result_echart DROP COLUMN IF EXISTS analysis_result_id')
    op.add_column('result_image', sa.Column('code_cell_id',
                  sa.UUID(), nullable=False), schema='analysis')
    op.add_column('result_image', sa.Column('created_at', sa.DateTime(
        timezone=True), nullable=False), schema='analysis')
    op.add_column('result_image', sa.Column('updated_at', sa.DateTime(
        timezone=True), nullable=False), schema='analysis')
    op.execute('ALTER TABLE analysis.result_image DROP CONSTRAINT IF EXISTS fk_result_image_analysis_result_id_analysis_result')
    op.create_foreign_key(op.f('fk_result_image_code_cell_id_code_cell'), 'result_image', 'code_cell', [
                          'code_cell_id'], ['id'], source_schema='analysis', referent_schema='analysis')
    op.execute(
        'ALTER TABLE analysis.result_image DROP COLUMN IF EXISTS analysis_result_id')
    op.add_column('result_table', sa.Column('code_cell_id',
                  sa.UUID(), nullable=False), schema='analysis')
    op.add_column('result_table', sa.Column('created_at', sa.DateTime(
        timezone=True), nullable=False), schema='analysis')
    op.add_column('result_table', sa.Column('updated_at', sa.DateTime(
        timezone=True), nullable=False), schema='analysis')
    op.execute('ALTER TABLE analysis.result_table DROP CONSTRAINT IF EXISTS fk_result_table_analysis_result_id_analysis_result')
    op.create_foreign_key(op.f('fk_result_table_code_cell_id_code_cell'), 'result_table', 'code_cell', [
                          'code_cell_id'], ['id'], source_schema='analysis', referent_schema='analysis')
    op.execute(
        'ALTER TABLE analysis.result_table DROP COLUMN IF EXISTS analysis_result_id')
    op.add_column('pipeline_run_output_model_entity', sa.Column(
        'model_instantiated_id', sa.UUID(), nullable=False), schema='entity_graph')
    op.execute('ALTER TABLE entity_graph.pipeline_run_output_model_entity DROP CONSTRAINT IF EXISTS uq_pipeline_run_output_model_entity_model_entity_id')
    op.create_unique_constraint('uq_pipeline_run_output_model_entity_model_entity_id',
                                'pipeline_run_output_model_entity', ['model_instantiated_id'], schema='entity_graph')
    op.execute('ALTER TABLE entity_graph.pipeline_run_output_model_entity DROP CONSTRAINT IF EXISTS fk_pipeline_run_output_model_entity_model_entity_id_mod_62ab')
    op.create_foreign_key(op.f('fk_pipeline_run_output_model_entity_model_instantiated_id_model_instantiated'), 'pipeline_run_output_model_entity',
                          'model_instantiated', ['model_instantiated_id'], ['id'], source_schema='entity_graph', referent_schema='model')
    op.execute(
        'ALTER TABLE entity_graph.pipeline_run_output_model_entity DROP COLUMN IF EXISTS model_entity_id')
    op.add_column('model_implementation', sa.Column(
        'modality', sa.String(), nullable=False), schema='model')
    op.add_column('model_implementation', sa.Column(
        'task', sa.String(), nullable=False), schema='model')
    op.add_column('model_implementation', sa.Column(
        'public', sa.Boolean(), nullable=False), schema='model')
    op.add_column('model_implementation', sa.Column(
        'source', sa.String(), nullable=False), schema='model')
    op.execute('ALTER TABLE model.model_implementation DROP CONSTRAINT IF EXISTS fk_model_implementation_definition_id_model_definition')
    op.execute('ALTER TABLE model.model_implementation DROP CONSTRAINT IF EXISTS fk_model_implementation_source_id_model_source')
    op.create_foreign_key(op.f('fk_model_implementation_id_model'), 'model_implementation', 'model', [
                          'id'], ['id'], source_schema='model', referent_schema='model')
    op.execute(
        'ALTER TABLE model.model_implementation DROP COLUMN IF EXISTS embedding')
    op.execute(
        'ALTER TABLE model.model_implementation DROP COLUMN IF EXISTS setup_script_path')
    op.execute(
        'ALTER TABLE model.model_implementation DROP COLUMN IF EXISTS definition_id')
    op.execute(
        'ALTER TABLE model.model_implementation DROP COLUMN IF EXISTS source_id')
    op.execute(
        'ALTER TABLE model.model_implementation DROP COLUMN IF EXISTS newest_update_description')
    op.execute(
        'ALTER TABLE model.model_implementation DROP COLUMN IF EXISTS version')
    op.alter_column('conversation', 'project_id',
                    existing_type=sa.UUID(),
                    nullable=True,
                    schema='orchestrator')
    op.execute(
        'ALTER TABLE orchestrator.conversation DROP CONSTRAINT IF EXISTS fk_conversation_project_id_project')
    op.execute(
        'ALTER TABLE runs.run DROP CONSTRAINT IF EXISTS fk_run_project_id_project')
    # Drop project schema and all its tables
    op.execute('DROP SCHEMA IF EXISTS project CASCADE')
    op.add_column('echart', sa.Column('user_id', sa.UUID(),
                  nullable=False), schema='visualization')
    op.add_column('image', sa.Column('user_id', sa.UUID(),
                  nullable=False), schema='visualization')
    op.add_column('table', sa.Column('user_id', sa.UUID(),
                  nullable=False), schema='visualization')
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_column('table', 'user_id', schema='visualization')
    op.drop_column('image', 'user_id', schema='visualization')
    op.drop_column('echart', 'user_id', schema='visualization')
    # Recreate project schema (if needed for backward compatibility)
    # Note: project schema tables would need to be recreated here if full rollback is required
    # op.execute('CREATE SCHEMA IF NOT EXISTS project')
    # op.create_foreign_key(op.f('fk_run_project_id_project'), 'run', 'project', [
    #                       'project_id'], ['id'], source_schema='runs', referent_schema='project')
    # op.create_foreign_key(op.f('fk_conversation_project_id_project'), 'conversation', 'project', [
    #                       'project_id'], ['id'], source_schema='orchestrator', referent_schema='project')
    op.alter_column('conversation', 'project_id',
                    existing_type=sa.UUID(),
                    nullable=False,
                    schema='orchestrator')
    op.add_column('model_implementation', sa.Column(
        'version', sa.INTEGER(), autoincrement=False, nullable=False), schema='model')
    op.add_column('model_implementation', sa.Column('newest_update_description',
                  sa.VARCHAR(), autoincrement=False, nullable=False), schema='model')
    op.add_column('model_implementation', sa.Column(
        'source_id', sa.UUID(), autoincrement=False, nullable=False), schema='model')
    op.add_column('model_implementation', sa.Column(
        'definition_id', sa.UUID(), autoincrement=False, nullable=False), schema='model')
    op.add_column('model_implementation', sa.Column('setup_script_path',
                  sa.VARCHAR(), autoincrement=False, nullable=True), schema='model')
    op.add_column('model_implementation', sa.Column(
        'embedding', sa.NullType(), autoincrement=False, nullable=False), schema='model')
    op.execute(
        'ALTER TABLE model.model_implementation DROP CONSTRAINT IF EXISTS fk_model_implementation_id_model')
    op.create_foreign_key(op.f('fk_model_implementation_source_id_model_source'), 'model_implementation', 'model_source', [
                          'source_id'], ['id'], source_schema='model', referent_schema='model')
    op.create_foreign_key(op.f('fk_model_implementation_definition_id_model_definition'), 'model_implementation',
                          'model_definition', ['definition_id'], ['id'], source_schema='model', referent_schema='model')
    op.drop_column('model_implementation', 'source', schema='model')
    op.drop_column('model_implementation', 'public', schema='model')
    op.drop_column('model_implementation', 'task', schema='model')
    op.drop_column('model_implementation', 'modality', schema='model')
    op.add_column('pipeline_run_output_model_entity', sa.Column(
        'model_entity_id', sa.UUID(), autoincrement=False, nullable=False), schema='entity_graph')
    op.execute('ALTER TABLE entity_graph.pipeline_run_output_model_entity DROP CONSTRAINT IF EXISTS fk_pipeline_run_output_model_entity_model_instantiated_id_model_instantiated')
    op.create_foreign_key(op.f('fk_pipeline_run_output_model_entity_model_entity_id_mod_62ab'), 'pipeline_run_output_model_entity',
                          'model_entity', ['model_entity_id'], ['id'], source_schema='entity_graph', referent_schema='model')
    op.execute('ALTER TABLE entity_graph.pipeline_run_output_model_entity DROP CONSTRAINT IF EXISTS uq_pipeline_run_output_model_entity_model_entity_id')
    op.create_unique_constraint(op.f('uq_pipeline_run_output_model_entity_model_entity_id'), 'pipeline_run_output_model_entity', [
                                'model_entity_id'], schema='entity_graph', postgresql_nulls_not_distinct=False)
    op.execute(
        'ALTER TABLE entity_graph.pipeline_run_output_model_entity DROP COLUMN IF EXISTS model_instantiated_id')
    op.add_column('result_table', sa.Column('analysis_result_id', sa.UUID(
    ), autoincrement=False, nullable=False), schema='analysis')
    op.execute(
        'ALTER TABLE analysis.result_table DROP CONSTRAINT IF EXISTS fk_result_table_code_cell_id_code_cell')
    op.create_foreign_key(op.f('fk_result_table_analysis_result_id_analysis_result'), 'result_table', 'analysis_result', [
                          'analysis_result_id'], ['id'], source_schema='analysis', referent_schema='analysis')
    op.execute(
        'ALTER TABLE analysis.result_table DROP COLUMN IF EXISTS updated_at')
    op.execute(
        'ALTER TABLE analysis.result_table DROP COLUMN IF EXISTS created_at')
    op.execute(
        'ALTER TABLE analysis.result_table DROP COLUMN IF EXISTS code_cell_id')
    op.add_column('result_image', sa.Column('analysis_result_id', sa.UUID(
    ), autoincrement=False, nullable=False), schema='analysis')
    op.execute(
        'ALTER TABLE analysis.result_image DROP CONSTRAINT IF EXISTS fk_result_image_code_cell_id_code_cell')
    op.create_foreign_key(op.f('fk_result_image_analysis_result_id_analysis_result'), 'result_image', 'analysis_result', [
                          'analysis_result_id'], ['id'], source_schema='analysis', referent_schema='analysis')
    op.execute(
        'ALTER TABLE analysis.result_image DROP COLUMN IF EXISTS updated_at')
    op.execute(
        'ALTER TABLE analysis.result_image DROP COLUMN IF EXISTS created_at')
    op.execute(
        'ALTER TABLE analysis.result_image DROP COLUMN IF EXISTS code_cell_id')
    op.add_column('result_echart', sa.Column('analysis_result_id', sa.UUID(
    ), autoincrement=False, nullable=False), schema='analysis')
    op.execute(
        'ALTER TABLE analysis.result_echart DROP CONSTRAINT IF EXISTS fk_result_echart_code_cell_id_code_cell')
    op.create_foreign_key(op.f('fk_result_echart_analysis_result_id_analysis_result'), 'result_echart', 'analysis_result', [
                          'analysis_result_id'], ['id'], source_schema='analysis', referent_schema='analysis')
    op.execute(
        'ALTER TABLE analysis.result_echart DROP COLUMN IF EXISTS updated_at')
    op.execute(
        'ALTER TABLE analysis.result_echart DROP COLUMN IF EXISTS created_at')
    op.execute(
        'ALTER TABLE analysis.result_echart DROP COLUMN IF EXISTS code_cell_id')
    op.add_column('analysis', sa.Column('report_generated', sa.BOOLEAN(
    ), autoincrement=False, nullable=False), schema='analysis')
    op.add_column('analysis', sa.Column('notebook_id', sa.UUID(),
                  autoincrement=False, nullable=False), schema='analysis')
    op.drop_column('analysis', 'updated_at', schema='analysis')
    op.create_table('model_source',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('type', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('name', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('description', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.CheckConstraint(
                        "type::text = ANY (ARRAY['github'::character varying, 'pypi'::character varying, 'gitlab'::character varying, 'huggingface'::character varying, 'local'::character varying]::text[])", name='model_source_type_check'),
                    sa.PrimaryKeyConstraint('id', name='pk_model_source'),
                    schema='model',
                    postgresql_ignore_search_path=False
                    )
    op.create_table('chat_pydantic_message',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('conversation_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('message_list', postgresql.BYTEA(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.ForeignKeyConstraint(['conversation_id'], ['orchestrator.conversation.id'], name=op.f(
                        'fk_chat_pydantic_message_conversation_id_conversation')),
                    sa.PrimaryKeyConstraint(
                        'id', name=op.f('pk_chat_pydantic_message')),
                    schema='orchestrator'
                    )
    op.create_table('function_in_pipeline',
                    sa.Column('pipeline_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('function_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.ForeignKeyConstraint(['function_id'], ['function.function.id'], name=op.f(
                        'fk_function_in_pipeline_function_id_function')),
                    sa.ForeignKeyConstraint(['pipeline_id'], ['pipeline.pipeline.id'], name=op.f(
                        'fk_function_in_pipeline_pipeline_id_pipeline')),
                    sa.PrimaryKeyConstraint(
                        'pipeline_id', 'function_id', name=op.f('pk_function_in_pipeline')),
                    schema='pipeline'
                    )
    op.create_table('model_entity_in_run',
                    sa.Column('run_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('model_entity_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.ForeignKeyConstraint(['model_entity_id'], ['model.model_entity.id'], name=op.f(
                        'fk_model_entity_in_run_model_entity_id_model_entity')),
                    sa.ForeignKeyConstraint(['run_id'], ['runs.run.id'], name=op.f(
                        'fk_model_entity_in_run_run_id_run')),
                    sa.PrimaryKeyConstraint(
                        'run_id', 'model_entity_id', name=op.f('pk_model_entity_in_run')),
                    schema='runs'
                    )
    op.create_table('model_entity_in_pipeline_run',
                    sa.Column('pipeline_run_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('model_entity_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.ForeignKeyConstraint(['model_entity_id'], ['model.model_entity.id'], name=op.f(
                        'fk_model_entity_in_pipeline_run_model_entity_id_model_entity')),
                    sa.ForeignKeyConstraint(['pipeline_run_id'], ['pipeline.pipeline_run.id'], name=op.f(
                        'fk_model_entity_in_pipeline_run_pipeline_run_id_pipeline_run')),
                    sa.PrimaryKeyConstraint('pipeline_run_id', 'model_entity_id', name=op.f(
                        'pk_model_entity_in_pipeline_run')),
                    schema='entity_graph'
                    )
    op.create_table('model_entity_implementation',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('model_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('config', postgresql.JSONB(astext_type=sa.Text()),
                              autoincrement=False, nullable=False),
                    sa.Column('weights_save_dir', sa.VARCHAR(),
                              autoincrement=False, nullable=True),
                    sa.Column('pipeline_id', sa.UUID(),
                              autoincrement=False, nullable=True),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.ForeignKeyConstraint(['id'], ['model.model_entity.id'], name=op.f(
                        'fk_model_entity_implementation_id_model_entity')),
                    sa.ForeignKeyConstraint(['model_id'], ['model.model_implementation.id'], name=op.f(
                        'fk_model_entity_implementation_model_id_model_implementation')),
                    sa.ForeignKeyConstraint(['pipeline_id'], ['pipeline.pipeline.id'], name=op.f(
                        'fk_model_entity_implementation_pipeline_id_pipeline')),
                    sa.PrimaryKeyConstraint('id', name=op.f(
                        'pk_model_entity_implementation')),
                    schema='model'
                    )
    op.create_table('notebook_section',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('notebook_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('section_name', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('section_description', sa.VARCHAR(),
                              autoincrement=False, nullable=True),
                    sa.Column('next_type', sa.VARCHAR(),
                              autoincrement=False, nullable=True),
                    sa.Column('next_id', sa.UUID(),
                              autoincrement=False, nullable=True),
                    sa.Column('parent_section_id', sa.UUID(),
                              autoincrement=False, nullable=True),
                    sa.ForeignKeyConstraint(['notebook_id'], [
                        'analysis.notebook.id'], name='fk_notebook_section_notebook_id_notebook'),
                    sa.ForeignKeyConstraint(['parent_section_id'], [
                        'analysis.notebook_section.id'], name='fk_notebook_section_parent_section_id_notebook_section'),
                    sa.PrimaryKeyConstraint('id', name='pk_notebook_section'),
                    schema='analysis',
                    postgresql_ignore_search_path=False
                    )
    op.create_table('analysis_result',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('analysis', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('python_code', sa.VARCHAR(),
                              autoincrement=False, nullable=True),
                    sa.Column('section_id', sa.UUID(),
                              autoincrement=False, nullable=True),
                    sa.Column('next_type', sa.VARCHAR(),
                              autoincrement=False, nullable=True),
                    sa.Column('next_id', sa.UUID(),
                              autoincrement=False, nullable=True),
                    sa.ForeignKeyConstraint(['section_id'], [
                        'analysis.notebook_section.id'], name='fk_analysis_result_section_id_notebook_section'),
                    sa.PrimaryKeyConstraint('id', name='pk_analysis_result'),
                    schema='analysis',
                    postgresql_ignore_search_path=False
                    )
    op.create_table('analysis_status_message',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('run_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('type', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('message', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(),
                              autoincrement=False, nullable=False),
                    sa.Column('analysis_result_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.ForeignKeyConstraint(['analysis_result_id'], ['analysis.analysis_result.id'], name=op.f(
                        'fk_analysis_status_message_analysis_result_id_analysis_result')),
                    sa.ForeignKeyConstraint(['run_id'], ['runs.run.id'], name=op.f(
                        'fk_analysis_status_message_run_id_run')),
                    sa.PrimaryKeyConstraint('id', name=op.f(
                        'pk_analysis_status_message')),
                    schema='analysis'
                    )
    op.create_table('model_entity_in_analysis',
                    sa.Column('analysis_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('model_entity_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.ForeignKeyConstraint(['analysis_id'], ['analysis.analysis.id'], name=op.f(
                        'fk_model_entity_in_analysis_analysis_id_analysis')),
                    sa.ForeignKeyConstraint(['model_entity_id'], ['model.model_entity.id'], name=op.f(
                        'fk_model_entity_in_analysis_model_entity_id_model_entity')),
                    schema='entity_graph'
                    )
    op.create_table('notebook',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.PrimaryKeyConstraint('id', name=op.f('pk_notebook')),
                    schema='analysis'
                    )
    op.create_table('model_entity_context',
                    sa.Column('context_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('model_entity_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.ForeignKeyConstraint(['context_id'], ['orchestrator.chat_context.id'], name=op.f(
                        'fk_model_entity_context_context_id_chat_context')),
                    sa.ForeignKeyConstraint(['model_entity_id'], ['model.model_entity.id'], name=op.f(
                        'fk_model_entity_context_model_entity_id_model_entity')),
                    sa.PrimaryKeyConstraint(
                        'context_id', 'model_entity_id', name=op.f('pk_model_entity_context')),
                    schema='orchestrator'
                    )
    op.create_table('model_entity',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('user_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('name', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('description', sa.VARCHAR(),
                              autoincrement=False, nullable=True),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.ForeignKeyConstraint(
                        ['user_id'], ['auth.users.id'], name='fk_model_entity_user_id_users'),
                    sa.PrimaryKeyConstraint('id', name='pk_model_entity'),
                    schema='model',
                    postgresql_ignore_search_path=False
                    )
    op.create_table('model_entity_supported_in_pipeline',
                    sa.Column('model_entity_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('pipeline_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.ForeignKeyConstraint(['model_entity_id'], ['model.model_entity.id'], name=op.f(
                        'fk_model_entity_supported_in_pipeline_model_entity_id_m_257d')),
                    sa.ForeignKeyConstraint(['pipeline_id'], ['pipeline.pipeline.id'], name=op.f(
                        'fk_model_entity_supported_in_pipeline_pipeline_id_pipeline')),
                    sa.PrimaryKeyConstraint('model_entity_id', 'pipeline_id', name=op.f(
                        'pk_model_entity_supported_in_pipeline')),
                    schema='entity_graph'
                    )
    op.create_table('pypi_model_source',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('package_name', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('package_version', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.ForeignKeyConstraint(['id'], ['model.model_source.id'], name=op.f(
                        'fk_pypi_model_source_id_model_source')),
                    sa.PrimaryKeyConstraint(
                        'id', name=op.f('pk_pypi_model_source')),
                    schema='model'
                    )
    op.create_table('model_entity_from_run',
                    sa.Column('run_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('model_entity_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.ForeignKeyConstraint(['model_entity_id'], ['model.model_entity.id'], name=op.f(
                        'fk_model_entity_from_run_model_entity_id_model_entity')),
                    sa.ForeignKeyConstraint(['run_id'], ['runs.run.id'], name=op.f(
                        'fk_model_entity_from_run_run_id_run')),
                    sa.PrimaryKeyConstraint(
                        'run_id', 'model_entity_id', name=op.f('pk_model_entity_from_run')),
                    schema='runs'
                    )
    op.create_table('model_definition',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('name', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('modality', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('task', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('public', sa.BOOLEAN(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.CheckConstraint("modality::text = ANY (ARRAY['time_series'::character varying, 'tabular'::character varying, 'multimodal'::character varying, 'image'::character varying, 'text'::character varying, 'audio'::character varying, 'video'::character varying]::text[])", name=op.f(
                        'model_definition_modality_check')),
                    sa.CheckConstraint("task::text = ANY (ARRAY['forecasting'::character varying, 'classification'::character varying, 'regression'::character varying, 'clustering'::character varying, 'anomaly_detection'::character varying, 'generation'::character varying, 'segmentation'::character varying]::text[])", name=op.f(
                        'model_definition_task_check')),
                    sa.PrimaryKeyConstraint(
                        'id', name=op.f('pk_model_definition')),
                    schema='model'
                    )
    op.execute('DROP TABLE IF EXISTS analysis.code_output CASCADE')
    op.execute('DROP TABLE IF EXISTS analysis.markdown_cell CASCADE')
    op.execute('DROP TABLE IF EXISTS analysis.code_cell CASCADE')
    op.execute('DROP TABLE IF EXISTS runs.model_instantiated_in_run CASCADE')
    op.execute('DROP TABLE IF EXISTS runs.model_instantiated_from_run CASCADE')
    op.execute(
        'DROP TABLE IF EXISTS orchestrator.model_instantiated_context CASCADE')
    op.execute('DROP TABLE IF EXISTS kvasir_v1.swe_deps CASCADE')
    op.execute('DROP TABLE IF EXISTS kvasir_v1.results_queue CASCADE')
    op.execute('DROP TABLE IF EXISTS kvasir_v1.result CASCADE')
    op.execute('DROP TABLE IF EXISTS kvasir_v1.pydantic_ai_message CASCADE')
    op.execute(
        'DROP TABLE IF EXISTS entity_graph.model_instantiated_supported_in_pipeline CASCADE')
    op.execute(
        'DROP TABLE IF EXISTS entity_graph.model_instantiated_in_pipeline_run CASCADE')
    op.execute(
        'DROP TABLE IF EXISTS entity_graph.model_instantiated_in_analysis CASCADE')
    op.execute('DROP TABLE IF EXISTS analysis.analysis_cell CASCADE')
    op.execute('DROP TABLE IF EXISTS model.model_instantiated CASCADE')
    op.execute('DROP TABLE IF EXISTS analysis.analysis_section CASCADE')
    op.execute('DROP TABLE IF EXISTS model.model CASCADE')
    op.execute('DROP TABLE IF EXISTS entity_graph.node_in_group CASCADE')
    op.execute('DROP TABLE IF EXISTS entity_graph.node_group CASCADE')
    op.execute('DROP TABLE IF EXISTS entity_graph.entity_node CASCADE')

    # Drop schemas
    op.execute('DROP SCHEMA IF EXISTS kvasir_v1 CASCADE')
    # ### end Alembic commands ###
