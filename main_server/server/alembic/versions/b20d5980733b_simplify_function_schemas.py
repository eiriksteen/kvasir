"""Simplify function schemas

Revision ID: b20d5980733b
Revises: 34d916cbfeea
Create Date: 2025-10-06 16:24:02.700670

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = 'b20d5980733b'
down_revision: Union[str, None] = '34d916cbfeea'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('pipeline_graph_node',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('type', sa.String(), nullable=False),
                    sa.Column('pipeline_id', sa.UUID(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.CheckConstraint(
                        "type IN ('dataset', 'function', 'model_entity')"),
                    sa.ForeignKeyConstraint(
                        ['pipeline_id'], ['pipeline.pipeline.id'], ),
                    sa.PrimaryKeyConstraint('id'),
                    schema='pipeline'
                    )
    op.create_table('object_group_in_pipeline',
                    sa.Column('pipeline_id', sa.UUID(), nullable=False),
                    sa.Column('object_group_id', sa.UUID(), nullable=False),
                    sa.Column('code_variable_name',
                              sa.String(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(['object_group_id'], [
                        'data_objects.object_group.id'], ),
                    sa.ForeignKeyConstraint(
                        ['pipeline_id'], ['pipeline.pipeline.id'], ),
                    sa.PrimaryKeyConstraint('pipeline_id', 'object_group_id'),
                    schema='pipeline'
                    )
    op.create_table('pipeline_graph_dataset_node',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('dataset_id', sa.UUID(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(
                        ['dataset_id'], ['data_objects.dataset.id'], ),
                    sa.ForeignKeyConstraint(
                        ['id'], ['pipeline.pipeline_graph_node.id'], ),
                    sa.PrimaryKeyConstraint('id'),
                    schema='pipeline'
                    )
    op.create_table('pipeline_graph_edge',
                    sa.Column('from_node_id', sa.UUID(), nullable=False),
                    sa.Column('to_node_id', sa.UUID(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(
                        ['from_node_id'], ['pipeline.pipeline_graph_node.id'], ),
                    sa.ForeignKeyConstraint(
                        ['to_node_id'], ['pipeline.pipeline_graph_node.id'], ),
                    sa.PrimaryKeyConstraint('from_node_id', 'to_node_id'),
                    schema='pipeline'
                    )
    op.create_table('pipeline_graph_function_node',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('function_id', sa.UUID(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(
                        ['function_id'], ['function.function.id'], ),
                    sa.ForeignKeyConstraint(
                        ['id'], ['pipeline.pipeline_graph_node.id'], ),
                    sa.PrimaryKeyConstraint('id'),
                    schema='pipeline'
                    )
    op.create_table('pipeline_graph_model_entity_node',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('model_entity_id', sa.UUID(), nullable=False),
                    sa.Column('function_type', sa.String(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.CheckConstraint(
                        "function_type IN ('training', 'inference')"),
                    sa.ForeignKeyConstraint(
                        ['id'], ['pipeline.pipeline_graph_node.id'], ),
                    sa.ForeignKeyConstraint(['model_entity_id'], [
                        'model.model_entity.id'], ),
                    sa.PrimaryKeyConstraint('id'),
                    schema='pipeline'
                    )
    op.drop_table('pipeline_output_variable_definition', schema='pipeline')
    op.drop_table('pipeline_function_node', schema='pipeline')
    op.drop_table('pipeline_from_dataset', schema='pipeline')
    op.drop_table('pipeline_input_object_group_from_dataset',
                  schema='pipeline')
    op.drop_table('function_output_variable_definition', schema='function')
    op.drop_table('pipeline_model_entity_node', schema='pipeline')
    op.drop_table('pipeline_dataset_node', schema='pipeline')
    op.drop_table('pipeline_edge', schema='pipeline')
    op.drop_table('pipeline_node', schema='pipeline')
    op.drop_table('model_function_output_variable_definition', schema='model')
    op.drop_table('variable', schema='data_objects')
    op.add_column('function', sa.Column('args_schema', postgresql.JSONB(
        astext_type=sa.Text()), nullable=False), schema='function')
    op.add_column('function', sa.Column('output_variables_schema', postgresql.JSONB(
        astext_type=sa.Text()), nullable=False), schema='function')
    op.add_column('function', sa.Column('python_function_name',
                  sa.String(), nullable=False), schema='function')
    op.add_column('function', sa.Column('default_args', postgresql.JSONB(
        astext_type=sa.Text()), nullable=True), schema='function')
    op.drop_column('function', 'default_args_dict', schema='function')
    op.create_unique_constraint(None, 'function_input_object_group_definition', [
                                'function_id', 'name'], schema='function')
    op.add_column('function_output_object_group_definition', sa.Column(
        'output_entity_id_name', sa.String(), nullable=False), schema='function')
    op.create_unique_constraint(None, 'function_output_object_group_definition', [
                                'function_id', 'name'], schema='function')
    op.add_column('model', sa.Column('python_class_name',
                  sa.String(), nullable=False), schema='model')
    op.drop_column('model_entity', 'inference_args', schema='model')
    op.drop_column('model_entity', 'training_args', schema='model')
    op.add_column('model_function', sa.Column('output_variables_schema', postgresql.JSONB(
        astext_type=sa.Text()), nullable=False), schema='model')
    op.alter_column('model_function_input_object_group_definition', 'description',
                    existing_type=sa.VARCHAR(),
                    nullable=False,
                    schema='model')
    op.alter_column('model_function_output_object_group_definition', 'description',
                    existing_type=sa.VARCHAR(),
                    nullable=False,
                    schema='model')
    op.drop_column('function_in_pipeline', 'id', schema='pipeline')
    op.add_column('model_entity_in_pipeline', sa.Column(
        'code_variable_name', sa.String(), nullable=False), schema='pipeline')
    op.add_column('pipeline', sa.Column('python_function_name',
                  sa.String(), nullable=False), schema='pipeline')
    op.add_column('pipeline', sa.Column('args', postgresql.JSONB(
        astext_type=sa.Text()), nullable=True), schema='pipeline')
    op.add_column('pipeline', sa.Column('args_schema', postgresql.JSONB(
        astext_type=sa.Text()), nullable=False), schema='pipeline')
    op.add_column('pipeline', sa.Column('output_variables_schema', postgresql.JSONB(
        astext_type=sa.Text()), nullable=False), schema='pipeline')
    op.drop_column('pipeline', 'args_dict', schema='pipeline')
    op.add_column('pipeline_output_object_group_definition', sa.Column(
        'name', sa.String(), nullable=False), schema='pipeline')
    op.add_column('pipeline_output_object_group_definition', sa.Column(
        'structure_id', sa.String(), nullable=False), schema='pipeline')
    op.add_column('pipeline_output_object_group_definition', sa.Column(
        'description', sa.String(), nullable=True), schema='pipeline')
    op.add_column('pipeline_output_object_group_definition', sa.Column(
        'output_entity_id_name', sa.String(), nullable=False), schema='pipeline')
    op.create_unique_constraint(None, 'pipeline_output_object_group_definition', [
                                'pipeline_id', 'name'], schema='pipeline')
    op.drop_constraint(op.f('pipeline_output_object_group_de_object_group_definition_id_fkey'),
                       'pipeline_output_object_group_definition', schema='pipeline', type_='foreignkey')
    op.drop_column('pipeline_output_object_group_definition',
                   'object_group_definition_id', schema='pipeline')
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.add_column('pipeline_output_object_group_definition', sa.Column(
        'object_group_definition_id', sa.UUID(), autoincrement=False, nullable=False), schema='pipeline')
    op.create_foreign_key(op.f('pipeline_output_object_group_de_object_group_definition_id_fkey'), 'pipeline_output_object_group_definition',
                          'function_output_object_group_definition', ['object_group_definition_id'], ['id'], source_schema='pipeline', referent_schema='function')
    op.drop_constraint(None, 'pipeline_output_object_group_definition',
                       schema='pipeline', type_='unique')
    op.drop_column('pipeline_output_object_group_definition',
                   'output_entity_id_name', schema='pipeline')
    op.drop_column('pipeline_output_object_group_definition',
                   'description', schema='pipeline')
    op.drop_column('pipeline_output_object_group_definition',
                   'structure_id', schema='pipeline')
    op.drop_column('pipeline_output_object_group_definition',
                   'name', schema='pipeline')
    op.add_column('pipeline', sa.Column('args_dict', postgresql.JSONB(
        astext_type=sa.Text()), autoincrement=False, nullable=True), schema='pipeline')
    op.drop_column('pipeline', 'output_variables_schema', schema='pipeline')
    op.drop_column('pipeline', 'args_schema', schema='pipeline')
    op.drop_column('pipeline', 'args', schema='pipeline')
    op.drop_column('pipeline', 'python_function_name', schema='pipeline')
    op.drop_column('model_entity_in_pipeline',
                   'code_variable_name', schema='pipeline')
    op.add_column('function_in_pipeline', sa.Column(
        'id', sa.UUID(), autoincrement=False, nullable=False), schema='pipeline')
    op.alter_column('model_function_output_object_group_definition', 'description',
                    existing_type=sa.VARCHAR(),
                    nullable=True,
                    schema='model')
    op.alter_column('model_function_input_object_group_definition', 'description',
                    existing_type=sa.VARCHAR(),
                    nullable=True,
                    schema='model')
    op.drop_column('model_function', 'output_variables_schema', schema='model')
    op.add_column('model_entity', sa.Column('training_args', postgresql.JSONB(
        astext_type=sa.Text()), autoincrement=False, nullable=False), schema='model')
    op.add_column('model_entity', sa.Column('inference_args', postgresql.JSONB(
        astext_type=sa.Text()), autoincrement=False, nullable=False), schema='model')
    op.drop_column('model', 'python_class_name', schema='model')
    op.drop_constraint(None, 'function_output_object_group_definition',
                       schema='function', type_='unique')
    op.drop_column('function_output_object_group_definition',
                   'output_entity_id_name', schema='function')
    op.drop_constraint(None, 'function_input_object_group_definition',
                       schema='function', type_='unique')
    op.add_column('function', sa.Column('default_args_dict', postgresql.JSONB(
        astext_type=sa.Text()), autoincrement=False, nullable=True), schema='function')
    op.drop_column('function', 'default_args', schema='function')
    op.drop_column('function', 'python_function_name', schema='function')
    op.drop_column('function', 'output_variables_schema', schema='function')
    op.drop_column('function', 'args_schema', schema='function')
    op.create_table('variable',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('variable_group_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('name', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('python_type', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('description', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.ForeignKeyConstraint(['variable_group_id'], [
                        'data_objects.variable_group.id'], name=op.f('variable_variable_group_id_fkey')),
                    sa.PrimaryKeyConstraint('id', name=op.f('variable_pkey')),
                    schema='data_objects'
                    )
    op.create_table('model_function_output_variable_definition',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('function_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('name', sa.VARCHAR(),
                              autoincrement=False, nullable=True),
                    sa.Column('python_type', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('description', sa.VARCHAR(),
                              autoincrement=False, nullable=True),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.ForeignKeyConstraint(['function_id'], ['model.model_function.id'], name=op.f(
                        'model_function_output_variable_definition_function_id_fkey')),
                    sa.PrimaryKeyConstraint('id', name=op.f(
                        'model_function_output_variable_definition_pkey')),
                    schema='model'
                    )
    op.create_table('pipeline_edge',
                    sa.Column('from_node_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('to_node_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.ForeignKeyConstraint(['from_node_id'], [
                        'pipeline.pipeline_node.id'], name=op.f('pipeline_edge_from_node_id_fkey')),
                    sa.ForeignKeyConstraint(['to_node_id'], ['pipeline.pipeline_node.id'], name=op.f(
                        'pipeline_edge_to_node_id_fkey')),
                    sa.PrimaryKeyConstraint(
                        'from_node_id', 'to_node_id', name=op.f('pipeline_edge_pkey')),
                    schema='pipeline'
                    )
    op.create_table('pipeline_dataset_node',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('dataset_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.ForeignKeyConstraint(['dataset_id'], ['data_objects.dataset.id'], name=op.f(
                        'pipeline_dataset_node_dataset_id_fkey')),
                    sa.ForeignKeyConstraint(['id'], ['pipeline.pipeline_node.id'], name=op.f(
                        'pipeline_dataset_node_id_fkey')),
                    sa.PrimaryKeyConstraint('id', name=op.f(
                        'pipeline_dataset_node_pkey')),
                    schema='pipeline'
                    )
    op.create_table('pipeline_model_entity_node',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('model_entity_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('function_type', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.CheckConstraint("function_type::text = ANY (ARRAY['training'::character varying, 'inference'::character varying]::text[])", name=op.f(
                        'pipeline_model_entity_node_function_type_check')),
                    sa.ForeignKeyConstraint(['id'], ['pipeline.pipeline_node.id'], name=op.f(
                        'pipeline_model_entity_node_id_fkey')),
                    sa.ForeignKeyConstraint(['model_entity_id'], ['model.model_entity.id'], name=op.f(
                        'pipeline_model_entity_node_model_entity_id_fkey')),
                    sa.PrimaryKeyConstraint('id', name=op.f(
                        'pipeline_model_entity_node_pkey')),
                    schema='pipeline'
                    )
    op.create_table('function_output_variable_definition',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('name', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('function_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('python_type', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('description', sa.VARCHAR(),
                              autoincrement=False, nullable=True),
                    sa.ForeignKeyConstraint(['function_id'], [
                        'function.function.id'], name='function_output_variable_definition_function_id_fkey'),
                    sa.PrimaryKeyConstraint(
                        'id', name='function_output_variable_definition_pkey'),
                    schema='function',
                    postgresql_ignore_search_path=False
                    )
    op.create_table('pipeline_input_object_group_from_dataset',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('pipeline_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('object_group_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.ForeignKeyConstraint(['object_group_id'], ['data_objects.object_group.id'], name=op.f(
                        'pipeline_input_object_group_from_dataset_object_group_id_fkey')),
                    sa.ForeignKeyConstraint(['pipeline_id'], ['pipeline.pipeline.id'], name=op.f(
                        'pipeline_input_object_group_from_dataset_pipeline_id_fkey')),
                    sa.PrimaryKeyConstraint('id', name=op.f(
                        'pipeline_input_object_group_from_dataset_pkey')),
                    schema='pipeline'
                    )
    op.create_table('pipeline_from_dataset',
                    sa.Column('dataset_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('pipeline_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.ForeignKeyConstraint(['dataset_id'], ['data_objects.dataset.id'], name=op.f(
                        'pipeline_from_dataset_dataset_id_fkey')),
                    sa.ForeignKeyConstraint(['pipeline_id'], ['pipeline.pipeline.id'], name=op.f(
                        'pipeline_from_dataset_pipeline_id_fkey')),
                    sa.PrimaryKeyConstraint('dataset_id', 'pipeline_id', name=op.f(
                        'pipeline_from_dataset_pkey')),
                    schema='pipeline'
                    )
    op.create_table('pipeline_function_node',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('function_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.ForeignKeyConstraint(['function_id'], ['function.function.id'], name=op.f(
                        'pipeline_function_node_function_id_fkey')),
                    sa.ForeignKeyConstraint(['id'], ['pipeline.pipeline_node.id'], name=op.f(
                        'pipeline_function_node_id_fkey')),
                    sa.PrimaryKeyConstraint('id', name=op.f(
                        'pipeline_function_node_pkey')),
                    schema='pipeline'
                    )
    op.create_table('pipeline_node',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('type', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('pipeline_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.CheckConstraint("type::text = ANY (ARRAY['dataset'::character varying, 'function'::character varying, 'model_entity'::character varying]::text[])", name=op.f(
                        'pipeline_node_type_check')),
                    sa.ForeignKeyConstraint(['pipeline_id'], ['pipeline.pipeline.id'], name=op.f(
                        'pipeline_node_pipeline_id_fkey')),
                    sa.PrimaryKeyConstraint(
                        'id', name=op.f('pipeline_node_pkey')),
                    schema='pipeline'
                    )
    op.create_table('pipeline_output_variable_definition',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('pipeline_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('variable_definition_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.ForeignKeyConstraint(['pipeline_id'], ['pipeline.pipeline.id'], name=op.f(
                        'pipeline_output_variable_definition_pipeline_id_fkey')),
                    sa.ForeignKeyConstraint(['variable_definition_id'], ['function.function_output_variable_definition.id'], name=op.f(
                        'pipeline_output_variable_definition_variable_definition_id_fkey')),
                    sa.PrimaryKeyConstraint('id', name=op.f(
                        'pipeline_output_variable_definition_pkey')),
                    schema='pipeline'
                    )
    op.drop_table('pipeline_graph_model_entity_node', schema='pipeline')
    op.drop_table('pipeline_graph_function_node', schema='pipeline')
    op.drop_table('pipeline_graph_edge', schema='pipeline')
    op.drop_table('pipeline_graph_dataset_node', schema='pipeline')
    op.drop_table('object_group_in_pipeline', schema='pipeline')
    op.drop_table('pipeline_graph_node', schema='pipeline')
    # ### end Alembic commands ###
