"""Update automation and add model integration models

Revision ID: ac5314e17791
Revises: b41be32e9e91
Create Date: 2025-06-25 12:00:24.461678

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql


# revision identifiers, used by Alembic.
revision: str = 'ac5314e17791'
down_revision: Union[str, None] = 'b41be32e9e91'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###

    # Create model_integration schema
    op.execute('CREATE SCHEMA IF NOT EXISTS model_integration')

    # Drop tables that reference the old automation table
    op.drop_table('automation_node', schema='node')
    op.drop_table('automation_context', schema='chat')
    op.drop_table('project_automation', schema='project')
    op.drop_table('analysis_jobs_automations', schema='analysis')

    # Drop the old automation table
    op.drop_table('automation', schema='automation')
    op.drop_table('model_job_result', schema='automation')

    # Create new automation tables
    op.create_table('modality',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('name', sa.String(), nullable=False),
                    sa.Column('description', sa.String(), nullable=True),
                    sa.PrimaryKeyConstraint('id'),
                    schema='automation'
                    )

    op.create_table('task',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('name', sa.String(), nullable=False),
                    sa.Column('description', sa.String(), nullable=True),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.PrimaryKeyConstraint('id'),
                    schema='automation'
                    )

    op.create_table('source',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('name', sa.String(), nullable=False),
                    sa.Column('description', sa.String(), nullable=True),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.PrimaryKeyConstraint('id'),
                    schema='automation'
                    )

    op.create_table('programming_language',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('name', sa.String(), nullable=False),
                    sa.Column('description', sa.String(), nullable=True),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.PrimaryKeyConstraint('id'),
                    schema='automation'
                    )

    op.create_table('programming_language_version',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('programming_language_id',
                              sa.UUID(), nullable=False),
                    sa.Column('version', sa.String(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(['programming_language_id'], [
                                            'automation.programming_language.id'], ),
                    sa.PrimaryKeyConstraint('id'),
                    schema='automation'
                    )

    op.create_table('model',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('name', sa.String(), nullable=False),
                    sa.Column('description', sa.String(), nullable=False),
                    sa.Column('owner_id', sa.UUID(), nullable=False),
                    sa.Column('public', sa.Boolean(), nullable=False),
                    sa.Column('modality_id', sa.UUID(), nullable=False),
                    sa.Column('source_id', sa.UUID(), nullable=False),
                    sa.Column('programming_language_version_id',
                              sa.UUID(), nullable=False),
                    sa.Column('setup_script_path',
                              sa.String(), nullable=False),
                    sa.Column('config_script_path',
                              sa.String(), nullable=False),
                    sa.Column('input_description',
                              sa.String(), nullable=False),
                    sa.Column('output_description',
                              sa.String(), nullable=False),
                    sa.Column('config_parameters', postgresql.JSONB(
                        astext_type=sa.Text()), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(
                        ['modality_id'], ['automation.modality.id'], ),
                    sa.ForeignKeyConstraint(['owner_id'], ['auth.users.id'], ),
                    sa.ForeignKeyConstraint(['programming_language_version_id'], [
                                            'automation.programming_language_version.id'], ),
                    sa.ForeignKeyConstraint(
                        ['source_id'], ['automation.source.id'], ),
                    sa.PrimaryKeyConstraint('id'),
                    schema='automation'
                    )

    op.create_table('model_task',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('model_id', sa.UUID(), nullable=False),
                    sa.Column('task_id', sa.UUID(), nullable=False),
                    sa.Column('inference_script_path',
                              sa.String(), nullable=False),
                    sa.Column('training_script_path',
                              sa.String(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(
                        ['model_id'], ['automation.model.id'], ),
                    sa.ForeignKeyConstraint(
                        ['task_id'], ['automation.task.id'], ),
                    sa.PrimaryKeyConstraint('id'),
                    schema='automation'
                    )

    # Recreate tables that reference automation with new model table
    op.create_table('analysis_jobs_automations',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('job_id', sa.UUID(), nullable=False),
                    sa.Column('automation_id', sa.UUID(), nullable=False),
                    sa.ForeignKeyConstraint(
                        ['automation_id'], ['automation.model.id'], ),
                    sa.ForeignKeyConstraint(['job_id'], ['jobs.jobs.id'], ),
                    sa.PrimaryKeyConstraint('id'),
                    schema='analysis'
                    )

    op.create_table('project_automation',
                    sa.Column('project_id', sa.UUID(), nullable=False),
                    sa.Column('automation_id', sa.UUID(), nullable=False),
                    sa.ForeignKeyConstraint(
                        ['project_id'], ['project.project.id'], ),
                    sa.ForeignKeyConstraint(
                        ['automation_id'], ['automation.model.id'], ),
                    sa.PrimaryKeyConstraint('project_id', 'automation_id'),
                    schema='project'
                    )

    op.create_table('automation_context',
                    sa.Column('context_id', sa.UUID(), nullable=False),
                    sa.Column('automation_id', sa.UUID(), nullable=False),
                    sa.ForeignKeyConstraint(
                        ['automation_id'], ['automation.model.id'], ),
                    sa.ForeignKeyConstraint(
                        ['context_id'], ['chat.context.id'], ),
                    sa.PrimaryKeyConstraint('context_id', 'automation_id'),
                    schema='chat'
                    )

    op.create_table('automation_node',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('automation_id', sa.UUID(), nullable=False),
                    sa.ForeignKeyConstraint(
                        ['automation_id'], ['automation.model.id'], ),
                    sa.ForeignKeyConstraint(['id'], ['node.node.id'], ),
                    sa.PrimaryKeyConstraint('id'),
                    schema='node'
                    )

    # Create model integration tables
    op.create_table('integration_jobs_results',
                    sa.Column('job_id', sa.UUID(), nullable=False),
                    sa.Column('model_id', sa.UUID(), nullable=False),
                    sa.ForeignKeyConstraint(['job_id'], ['jobs.jobs.id'], ),
                    sa.PrimaryKeyConstraint('job_id'),
                    schema='model_integration'
                    )

    op.create_table('model_integration_pydantic_message',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('job_id', sa.UUID(), nullable=True),
                    sa.Column('message_list', postgresql.BYTEA(),
                              nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(['job_id'], ['jobs.jobs.id'], ),
                    sa.PrimaryKeyConstraint('id'),
                    schema='model_integration'
                    )

    op.create_table('model_integration_message',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('job_id', sa.UUID(), nullable=True),
                    sa.Column('content', sa.String(), nullable=False),
                    sa.Column('stage', sa.String(), nullable=False),
                    sa.Column('current_task', sa.String(), nullable=True),
                    sa.Column('type', sa.String(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(['job_id'], ['jobs.jobs.id'], ),
                    sa.PrimaryKeyConstraint('id'),
                    schema='model_integration'
                    )

    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###

    # Drop model integration tables
    op.drop_table('model_integration_message', schema='model_integration')
    op.drop_table('model_integration_pydantic_message',
                  schema='model_integration')
    op.drop_table('integration_jobs_results', schema='model_integration')

    # Drop tables that reference the new model table
    op.drop_table('automation_node', schema='node')
    op.drop_table('automation_context', schema='chat')
    op.drop_table('project_automation', schema='project')
    op.drop_table('analysis_jobs_automations', schema='analysis')

    # Drop new automation tables
    op.drop_table('model_task', schema='automation')
    op.drop_table('model', schema='automation')
    op.drop_table('programming_language_version', schema='automation')
    op.drop_table('programming_language', schema='automation')
    op.drop_table('source', schema='automation')
    op.drop_table('task', schema='automation')
    op.drop_table('modality', schema='automation')

    # Recreate the old automation table
    op.create_table('automation',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('name', sa.String(), nullable=False),
                    sa.PrimaryKeyConstraint('id'),
                    schema='automation'
                    )

    op.create_table('model_job_result',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('job_id', sa.UUID(), nullable=False),
                    sa.Column('explanation', sa.String(), nullable=False),
                    sa.Column('python_code', sa.String(), nullable=False),
                    sa.ForeignKeyConstraint(['job_id'], ['jobs.jobs.id'], ),
                    sa.PrimaryKeyConstraint('id'),
                    schema='automation'
                    )

    # Recreate tables that reference the old automation table
    op.create_table('analysis_jobs_automations',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('job_id', sa.UUID(), nullable=False),
                    sa.Column('automation_id', sa.UUID(), nullable=False),
                    sa.ForeignKeyConstraint(
                        ['automation_id'], ['automation.automation.id'], ),
                    sa.ForeignKeyConstraint(['job_id'], ['jobs.jobs.id'], ),
                    sa.PrimaryKeyConstraint('id'),
                    schema='analysis'
                    )

    op.create_table('project_automation',
                    sa.Column('project_id', sa.UUID(), nullable=False),
                    sa.Column('automation_id', sa.UUID(), nullable=False),
                    sa.ForeignKeyConstraint(
                        ['project_id'], ['project.project.id'], ),
                    sa.PrimaryKeyConstraint('project_id', 'automation_id'),
                    schema='project'
                    )

    op.create_table('automation_context',
                    sa.Column('context_id', sa.UUID(), nullable=False),
                    sa.Column('automation_id', sa.UUID(), nullable=False),
                    sa.ForeignKeyConstraint(
                        ['automation_id'], ['automation.automation.id'], ),
                    sa.ForeignKeyConstraint(
                        ['context_id'], ['chat.context.id'], ),
                    sa.PrimaryKeyConstraint('context_id', 'automation_id'),
                    schema='chat'
                    )

    op.create_table('automation_node',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('automation_id', sa.UUID(), nullable=False),
                    sa.ForeignKeyConstraint(
                        ['automation_id'], ['automation.automation.id'], ),
                    sa.ForeignKeyConstraint(['id'], ['node.node.id'], ),
                    sa.PrimaryKeyConstraint('id'),
                    schema='node'
                    )

    # Drop model_integration schema
    op.execute('DROP SCHEMA IF EXISTS model_integration CASCADE')

    # ### end Alembic commands ###
