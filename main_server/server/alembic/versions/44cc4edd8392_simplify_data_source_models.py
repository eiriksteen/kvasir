"""simplify data source models

Revision ID: 44cc4edd8392
Revises: 14779194f837
Create Date: 2025-10-19 18:47:31.783382

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
import pgvector
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = '44cc4edd8392'
down_revision: Union[str, None] = '14779194f837'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('key_value_file_data_source',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('file_name', sa.String(), nullable=False),
                    sa.Column('file_path', sa.String(), nullable=False),
                    sa.Column('file_type', sa.String(), nullable=False),
                    sa.Column('file_size_bytes',
                              sa.BigInteger(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(['id'], ['data_sources.data_source.id'], name=op.f(
                        'fk_key_value_file_data_source_id_data_source')),
                    sa.PrimaryKeyConstraint('id', name=op.f(
                        'pk_key_value_file_data_source')),
                    schema='data_sources'
                    )
    op.create_table('model_implementation',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.Column('definition_id', sa.UUID(), nullable=False),
                    sa.Column('python_class_name',
                              sa.String(), nullable=False),
                    sa.Column('version', sa.Integer(), nullable=False),
                    sa.Column('description', sa.String(), nullable=False),
                    sa.Column('newest_update_description',
                              sa.String(), nullable=False),
                    sa.Column('embedding', pgvector.sqlalchemy.vector.VECTOR(
                        dim=1536), nullable=False),
                    sa.Column('source_id', sa.UUID(), nullable=False),
                    sa.Column('user_id', sa.UUID(), nullable=False),
                    sa.Column('config_schema', postgresql.JSONB(
                        astext_type=sa.Text()), nullable=False),
                    sa.Column('default_config', postgresql.JSONB(
                        astext_type=sa.Text()), nullable=False),
                    sa.Column('implementation_script_id',
                              sa.UUID(), nullable=False),
                    sa.Column('setup_script_id', sa.UUID(), nullable=True),
                    sa.Column('model_class_docstring',
                              sa.String(), nullable=False),
                    sa.Column('training_function_id',
                              sa.UUID(), nullable=False),
                    sa.Column('inference_function_id',
                              sa.UUID(), nullable=False),
                    sa.Column('created_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.Column('updated_at', sa.DateTime(
                        timezone=True), nullable=False),
                    sa.ForeignKeyConstraint(['definition_id'], ['model.model_definition.id'], name=op.f(
                        'fk_model_implementation_definition_id_model_definition')),
                    sa.ForeignKeyConstraint(['implementation_script_id'], ['code.script.id'], name=op.f(
                        'fk_model_implementation_implementation_script_id_script')),
                    sa.ForeignKeyConstraint(['inference_function_id'], ['model.model_function.id'], name=op.f(
                        'fk_model_implementation_inference_function_id_model_function')),
                    sa.ForeignKeyConstraint(['setup_script_id'], ['code.script.id'], name=op.f(
                        'fk_model_implementation_setup_script_id_script')),
                    sa.ForeignKeyConstraint(['source_id'], ['model.model_source.id'], name=op.f(
                        'fk_model_implementation_source_id_model_source')),
                    sa.ForeignKeyConstraint(['training_function_id'], ['model.model_function.id'], name=op.f(
                        'fk_model_implementation_training_function_id_model_function')),
                    sa.ForeignKeyConstraint(['user_id'], ['auth.users.id'], name=op.f(
                        'fk_model_implementation_user_id_users')),
                    sa.PrimaryKeyConstraint(
                        'id', name=op.f('pk_model_implementation')),
                    schema='model'
                    )
    # op.drop_table('model', schema='model')
    op.execute("DROP TABLE model.model CASCADE")
    op.drop_table('feature_in_tabular_file', schema='data_sources')
    op.add_column('tabular_file_data_source', sa.Column('json_schema', postgresql.JSONB(
        astext_type=sa.Text()), nullable=False), schema='data_sources')
    op.alter_column('tabular_file_data_source', 'content_preview',
                    existing_type=sa.VARCHAR(),
                    nullable=False,
                    schema='data_sources')
    op.create_foreign_key(op.f('fk_model_entity_implementation_model_id_model_implementation'), 'model_entity_implementation',
                          'model_implementation', ['model_id'], ['id'], source_schema='model', referent_schema='model')
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint(op.f('fk_model_entity_implementation_model_id_model_implementation'),
                       'model_entity_implementation', schema='model', type_='foreignkey')
    op.create_foreign_key(op.f('fk_model_entity_implementation_model_id_model'), 'model_entity_implementation', 'model', [
                          'model_id'], ['id'], source_schema='model', referent_schema='model')
    op.alter_column('tabular_file_data_source', 'content_preview',
                    existing_type=sa.VARCHAR(),
                    nullable=True,
                    schema='data_sources')
    op.drop_column('tabular_file_data_source',
                   'json_schema', schema='data_sources')
    op.create_table('feature_in_tabular_file',
                    sa.Column('feature_name', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('tabular_file_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.ForeignKeyConstraint(['feature_name'], ['data_objects.feature.name'], name=op.f(
                        'feature_in_tabular_file_feature_name_fkey')),
                    sa.ForeignKeyConstraint(['tabular_file_id'], ['data_sources.tabular_file_data_source.id'], name=op.f(
                        'feature_in_tabular_file_tabular_file_id_fkey')),
                    sa.PrimaryKeyConstraint('feature_name', 'tabular_file_id', name=op.f(
                        'feature_in_tabular_file_pkey')),
                    schema='data_sources'
                    )
    op.create_table('model',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('description', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('embedding', pgvector.sqlalchemy.vector.VECTOR(
                        dim=1536), autoincrement=False, nullable=False),
                    sa.Column('source_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('default_config', postgresql.JSONB(
                        astext_type=sa.Text()), autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('updated_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.Column('user_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('model_class_docstring', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('config_schema', postgresql.JSONB(
                        astext_type=sa.Text()), autoincrement=False, nullable=False),
                    sa.Column('definition_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('version', sa.INTEGER(),
                              autoincrement=False, nullable=False),
                    sa.Column('newest_update_description', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('training_function_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('inference_function_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('python_class_name', sa.VARCHAR(),
                              autoincrement=False, nullable=False),
                    sa.Column('implementation_script_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('setup_script_id', sa.UUID(),
                              autoincrement=False, nullable=True),
                    sa.ForeignKeyConstraint(['definition_id'], [
                        'model.model_definition.id'], name=op.f('model_definition_id_fkey')),
                    sa.ForeignKeyConstraint(['implementation_script_id'], [
                        'code.script.id'], name=op.f('fk_model_implementation_script_id_script')),
                    sa.ForeignKeyConstraint(['inference_function_id'], [
                        'model.model_function.id'], name=op.f('model_inference_function_id_fkey')),
                    sa.ForeignKeyConstraint(['setup_script_id'], ['code.script.id'], name=op.f(
                        'fk_model_setup_script_id_script')),
                    sa.ForeignKeyConstraint(
                        ['source_id'], ['model.model_source.id'], name=op.f('model_source_id_fkey')),
                    sa.ForeignKeyConstraint(['training_function_id'], [
                        'model.model_function.id'], name=op.f('model_training_function_id_fkey')),
                    sa.ForeignKeyConstraint(
                        ['user_id'], ['auth.users.id'], name=op.f('model_user_id_fkey')),
                    sa.PrimaryKeyConstraint('id', name=op.f('model_pkey')),
                    schema='model'
                    )
    op.drop_table('model_implementation', schema='model')
    op.drop_table('key_value_file_data_source', schema='data_sources')
    op.drop_table('script', schema='code')
    # ### end Alembic commands ###
