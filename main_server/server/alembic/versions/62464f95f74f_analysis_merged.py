"""analysis merged

Revision ID: 62464f95f74f
Revises: 9ca5afd2a9ea
Create Date: 2025-10-03 18:18:48.191173

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = '62464f95f74f'
down_revision: Union[str, None] = '9ca5afd2a9ea'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.execute('CREATE SCHEMA IF NOT EXISTS tables')
    op.execute('CREATE SCHEMA IF NOT EXISTS plots')
    op.create_table('notebooks',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_notebooks')),
    schema='analysis'
    )
    op.create_table('notebook_sections',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('notebook_id', sa.UUID(), nullable=False),
    sa.Column('section_name', sa.String(), nullable=False),
    sa.Column('section_description', sa.String(), nullable=True),
    sa.Column('next_type', sa.String(), nullable=True),
    sa.Column('next_id', sa.UUID(), nullable=True),
    sa.Column('parent_section_id', sa.UUID(), nullable=True),
    sa.ForeignKeyConstraint(['notebook_id'], ['analysis.notebooks.id'], name=op.f('fk_notebook_sections_notebook_id_notebooks')),
    sa.ForeignKeyConstraint(['parent_section_id'], ['analysis.notebook_sections.id'], name=op.f('fk_notebook_sections_parent_section_id_notebook_sections')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_notebook_sections')),
    schema='analysis'
    )
    op.create_table('analysis_objects',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('project_id', sa.UUID(), nullable=False),
    sa.Column('user_id', sa.UUID(), nullable=False),
    sa.Column('name', sa.String(), nullable=False),
    sa.Column('description', sa.String(), nullable=True),
    sa.Column('created_at', sa.DateTime(), nullable=False),
    sa.Column('report_generated', sa.Boolean(), nullable=False),
    sa.Column('notebook_id', sa.UUID(), nullable=False),
    sa.ForeignKeyConstraint(['project_id'], ['project.project.id'], name=op.f('fk_analysis_objects_project_id_project')),
    sa.ForeignKeyConstraint(['user_id'], ['auth.users.id'], name=op.f('fk_analysis_objects_user_id_users')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_analysis_objects')),
    schema='analysis'
    )
    op.create_table('analysis_results',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('analysis', sa.String(), nullable=False),
    sa.Column('python_code', sa.String(), nullable=True),
    sa.Column('output_variable', sa.String(), nullable=True),
    sa.Column('input_variable', sa.String(), nullable=True),
    sa.Column('section_id', sa.UUID(), nullable=True),
    sa.Column('next_type', sa.String(), nullable=True),
    sa.Column('next_id', sa.UUID(), nullable=True),
    sa.ForeignKeyConstraint(['section_id'], ['analysis.notebook_sections.id'], name=op.f('fk_analysis_results_section_id_notebook_sections')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_analysis_results')),
    schema='analysis'
    )
    op.create_table('analysis_objects_datasets',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('analysis_object_id', sa.UUID(), nullable=False),
    sa.Column('dataset_id', sa.UUID(), nullable=False),
    sa.ForeignKeyConstraint(['analysis_object_id'], ['analysis.analysis_objects.id'], name=op.f('fk_analysis_objects_datasets_analysis_object_id_analysis_objects')),
    sa.ForeignKeyConstraint(['dataset_id'], ['data_objects.dataset.id'], name=op.f('fk_analysis_objects_datasets_dataset_id_dataset')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_analysis_objects_datasets')),
    schema='analysis'
    )
    op.create_table('analysis_results_data_sources',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('analysis_result_id', sa.UUID(), nullable=False),
    sa.Column('data_source_id', sa.UUID(), nullable=False),
    sa.ForeignKeyConstraint(['analysis_result_id'], ['analysis.analysis_results.id'], name=op.f('fk_analysis_results_data_sources_analysis_result_id_analysis_results')),
    sa.ForeignKeyConstraint(['data_source_id'], ['data_sources.data_source.id'], name=op.f('fk_analysis_results_data_sources_data_source_id_data_source')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_analysis_results_data_sources')),
    schema='analysis'
    )
    op.create_table('analysis_results_datasets',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('analysis_result_id', sa.UUID(), nullable=False),
    sa.Column('dataset_id', sa.UUID(), nullable=False),
    sa.ForeignKeyConstraint(['analysis_result_id'], ['analysis.analysis_results.id'], name=op.f('fk_analysis_results_datasets_analysis_result_id_analysis_results')),
    sa.ForeignKeyConstraint(['dataset_id'], ['data_objects.dataset.id'], name=op.f('fk_analysis_results_datasets_dataset_id_dataset')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_analysis_results_datasets')),
    schema='analysis'
    )
    op.create_table('plots',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('analysis_result_id', sa.UUID(), nullable=False),
    sa.Column('plot_config', sa.JSON(), nullable=False),
    sa.ForeignKeyConstraint(['analysis_result_id'], ['analysis.analysis_results.id'], name=op.f('fk_plots_analysis_result_id_analysis_results')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_plots')),
    schema='plots'
    )
    op.create_table('tables',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('analysis_result_id', sa.UUID(), nullable=False),
    sa.Column('table_config', sa.JSON(), nullable=False),
    sa.ForeignKeyConstraint(['analysis_result_id'], ['analysis.analysis_results.id'], name=op.f('fk_tables_analysis_result_id_analysis_results')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_tables')),
    schema='tables'
    )
    op.create_table('analysis_result_runs',
    sa.Column('id', sa.UUID(), nullable=False),
    sa.Column('analysis_result_id', sa.UUID(), nullable=False),
    sa.Column('run_id', sa.UUID(), nullable=False),
    sa.ForeignKeyConstraint(['analysis_result_id'], ['analysis.analysis_results.id'], name=op.f('fk_analysis_result_runs_analysis_result_id_analysis_results')),
    sa.ForeignKeyConstraint(['run_id'], ['runs.run.id'], name=op.f('fk_analysis_result_runs_run_id_run')),
    sa.PrimaryKeyConstraint('id', name=op.f('pk_analysis_result_runs')),
    schema='analysis'
    )
    op.drop_constraint(op.f('analysis_context_analysis_id_fkey'), 'analysis_context', schema='orchestrator', type_='foreignkey')
    op.drop_constraint(op.f('analysis_node_analysis_id_fkey'), 'analysis_node', schema='node', type_='foreignkey')
    op.drop_constraint(op.f('project_analysis_analysis_id_fkey'), 'project_analysis', schema='project', type_='foreignkey')
    op.drop_table('analysis_jobs_datasets', schema='analysis')
    op.drop_table('analysis_jobs_pipelines', schema='analysis')
    op.drop_table('analysis_jobs_results', schema='analysis')
    op.add_column('analysis_status_messages', sa.Column('run_id', sa.UUID(), nullable=False), schema='analysis')
    op.add_column('analysis_status_messages', sa.Column('analysis_result_id', sa.UUID(), nullable=False), schema='analysis')
    op.alter_column('analysis_status_messages', 'created_at',
               existing_type=postgresql.TIMESTAMP(timezone=True),
               type_=sa.DateTime(),
               existing_nullable=False,
               schema='analysis')
    op.drop_constraint(op.f('analysis_status_messages_job_id_fkey'), 'analysis_status_messages', schema='analysis', type_='foreignkey')
    op.create_foreign_key(op.f('fk_analysis_status_messages_analysis_result_id_analysis_results'), 'analysis_status_messages', 'analysis_results', ['analysis_result_id'], ['id'], source_schema='analysis', referent_schema='analysis')
    op.create_foreign_key(op.f('fk_analysis_status_messages_run_id_run'), 'analysis_status_messages', 'run', ['run_id'], ['id'], source_schema='analysis', referent_schema='runs')
    op.drop_column('analysis_status_messages', 'job_id', schema='analysis')
    op.drop_constraint(op.f('user_api_keys_key_key'), 'user_api_keys', schema='auth', type_='unique')
    op.create_unique_constraint(op.f('uq_user_api_keys_key'), 'user_api_keys', ['key'], schema='auth')
    op.drop_constraint(op.f('users_email_key'), 'users', schema='auth', type_='unique')
    op.create_unique_constraint(op.f('uq_users_email'), 'users', ['email'], schema='auth')
    op.create_foreign_key(op.f('fk_analysis_node_analysis_id_analysis_objects'), 'analysis_node', 'analysis_objects', ['analysis_id'], ['id'], source_schema='node', referent_schema='analysis')
    op.create_foreign_key(op.f('fk_analysis_context_analysis_id_analysis_objects'), 'analysis_context', 'analysis_objects', ['analysis_id'], ['id'], source_schema='orchestrator', referent_schema='analysis')
    
    op.create_foreign_key(op.f('fk_project_analysis_analysis_id_analysis_objects'), 'project_analysis', 'analysis_objects', ['analysis_id'], ['id'], source_schema='project', referent_schema='analysis')
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint(op.f('fk_project_analysis_analysis_id_analysis_objects'), 'project_analysis', schema='project', type_='foreignkey')
    op.create_foreign_key(op.f('project_analysis_analysis_id_fkey'), 'project_analysis', 'analysis_jobs_results', ['analysis_id'], ['job_id'], source_schema='project', referent_schema='analysis')
    op.drop_constraint(op.f('fk_analysis_context_analysis_id_analysis_objects'), 'analysis_context', schema='orchestrator', type_='foreignkey')
    op.create_foreign_key(op.f('analysis_context_analysis_id_fkey'), 'analysis_context', 'analysis_jobs_results', ['analysis_id'], ['job_id'], source_schema='orchestrator', referent_schema='analysis')
    op.drop_constraint(op.f('fk_analysis_node_analysis_id_analysis_objects'), 'analysis_node', schema='node', type_='foreignkey')
    op.create_foreign_key(op.f('analysis_node_analysis_id_fkey'), 'analysis_node', 'analysis_jobs_results', ['analysis_id'], ['job_id'], source_schema='node', referent_schema='analysis')
    op.drop_constraint(op.f('uq_users_email'), 'users', schema='auth', type_='unique')
    op.create_unique_constraint(op.f('users_email_key'), 'users', ['email'], schema='auth', postgresql_nulls_not_distinct=False)
    op.drop_constraint(op.f('uq_user_api_keys_key'), 'user_api_keys', schema='auth', type_='unique')
    op.create_unique_constraint(op.f('user_api_keys_key_key'), 'user_api_keys', ['key'], schema='auth', postgresql_nulls_not_distinct=False)
    op.add_column('analysis_status_messages', sa.Column('job_id', sa.UUID(), autoincrement=False, nullable=False), schema='analysis')
    op.drop_constraint(op.f('fk_analysis_status_messages_run_id_run'), 'analysis_status_messages', schema='analysis', type_='foreignkey')
    op.drop_constraint(op.f('fk_analysis_status_messages_analysis_result_id_analysis_results'), 'analysis_status_messages', schema='analysis', type_='foreignkey')
    op.create_foreign_key(op.f('analysis_status_messages_job_id_fkey'), 'analysis_status_messages', 'run', ['job_id'], ['id'], source_schema='analysis', referent_schema='runs')
    op.alter_column('analysis_status_messages', 'created_at',
               existing_type=sa.DateTime(),
               type_=postgresql.TIMESTAMP(timezone=True),
               existing_nullable=False,
               schema='analysis')
    op.drop_column('analysis_status_messages', 'analysis_result_id', schema='analysis')
    op.drop_column('analysis_status_messages', 'run_id', schema='analysis')
    op.create_table('analysis_jobs_results',
    sa.Column('job_id', sa.UUID(), autoincrement=False, nullable=False),
    sa.Column('name', sa.VARCHAR(), autoincrement=False, nullable=False),
    sa.Column('number_of_datasets', sa.INTEGER(), autoincrement=False, nullable=False),
    sa.Column('analysis_plan', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=False),
    sa.Column('created_at', postgresql.TIMESTAMP(timezone=True), autoincrement=False, nullable=False),
    sa.Column('pdf_created', sa.BOOLEAN(), autoincrement=False, nullable=False),
    sa.Column('pdf_s3_path', sa.VARCHAR(), autoincrement=False, nullable=True),
    sa.Column('user_id', sa.UUID(), autoincrement=False, nullable=False),
    sa.Column('number_of_pipelines', sa.INTEGER(), autoincrement=False, nullable=False),
    sa.ForeignKeyConstraint(['job_id'], ['runs.run.id'], name=op.f('analysis_jobs_results_job_id_fkey')),
    sa.ForeignKeyConstraint(['user_id'], ['auth.users.id'], name=op.f('analysis_jobs_results_user_id_fkey')),
    sa.PrimaryKeyConstraint('job_id', name=op.f('analysis_jobs_results_pkey')),
    schema='analysis'
    )
    op.create_table('analysis_jobs_pipelines',
    sa.Column('id', sa.UUID(), autoincrement=False, nullable=False),
    sa.Column('job_id', sa.UUID(), autoincrement=False, nullable=False),
    sa.Column('pipeline_id', sa.UUID(), autoincrement=False, nullable=False),
    sa.ForeignKeyConstraint(['job_id'], ['runs.run.id'], name=op.f('analysis_jobs_pipelines_job_id_fkey')),
    sa.ForeignKeyConstraint(['pipeline_id'], ['pipeline.pipeline.id'], name=op.f('analysis_jobs_pipelines_pipeline_id_fkey')),
    sa.PrimaryKeyConstraint('id', name=op.f('analysis_jobs_pipelines_pkey')),
    schema='analysis'
    )
    op.create_table('analysis_jobs_datasets',
    sa.Column('id', sa.UUID(), autoincrement=False, nullable=False),
    sa.Column('job_id', sa.UUID(), autoincrement=False, nullable=False),
    sa.Column('dataset_id', sa.UUID(), autoincrement=False, nullable=False),
    sa.ForeignKeyConstraint(['dataset_id'], ['data_objects.dataset.id'], name=op.f('analysis_jobs_datasets_dataset_id_fkey')),
    sa.ForeignKeyConstraint(['job_id'], ['runs.run.id'], name=op.f('analysis_jobs_datasets_job_id_fkey')),
    sa.PrimaryKeyConstraint('id', name=op.f('analysis_jobs_datasets_pkey')),
    schema='analysis'
    )
    op.drop_table('analysis_result_runs', schema='analysis')
    op.drop_table('tables', schema='tables')
    op.drop_table('plots', schema='plots')
    op.drop_table('analysis_results_datasets', schema='analysis')
    op.drop_table('analysis_results_data_sources', schema='analysis')
    op.drop_table('analysis_objects_datasets', schema='analysis')
    op.drop_table('analysis_results', schema='analysis')
    op.drop_table('analysis_objects', schema='analysis')
    op.drop_table('notebook_sections', schema='analysis')
    op.drop_table('notebooks', schema='analysis')
    # ### end Alembic commands ###
