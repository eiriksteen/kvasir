"""update_orchestrator_models

Revision ID: eb77ea7c5cdf
Revises: a80c17131916
Create Date: 2025-08-03 12:57:59.112917

"""
from typing import Sequence, Union

from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision: str = 'eb77ea7c5cdf'
down_revision: Union[str, None] = 'a80c17131916'
branch_labels: Union[str, Sequence[str], None] = None
depends_on: Union[str, Sequence[str], None] = None


def upgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.create_table('chat_context',
                    sa.Column('id', sa.UUID(), nullable=False),
                    sa.PrimaryKeyConstraint('id'),
                    schema='orchestrator'
                    )
    op.drop_table('run_in_conversation', schema='orchestrator')

    # Drop foreign key constraints first
    op.drop_constraint('analysis_context_context_id_fkey',
                       'analysis_context', schema='orchestrator', type_='foreignkey')
    op.drop_constraint('automation_context_context_id_fkey',
                       'automation_context', schema='orchestrator', type_='foreignkey')
    op.drop_constraint('chat_message_context_id_fkey',
                       'chat_message', schema='orchestrator', type_='foreignkey')
    op.drop_constraint('data_source_context_context_id_fkey',
                       'data_source_context', schema='orchestrator', type_='foreignkey')
    op.drop_constraint('dataset_context_context_id_fkey',
                       'dataset_context', schema='orchestrator', type_='foreignkey')

    # Now drop the old context table
    op.drop_table('context', schema='orchestrator')

    # Create new foreign key constraints
    op.create_foreign_key(None, 'analysis_context', 'chat_context', ['context_id'], [
                          'id'], source_schema='orchestrator', referent_schema='orchestrator')
    op.create_foreign_key(None, 'automation_context', 'chat_context', ['context_id'], [
                          'id'], source_schema='orchestrator', referent_schema='orchestrator')
    op.create_foreign_key(None, 'chat_message', 'chat_context', ['context_id'], [
                          'id'], source_schema='orchestrator', referent_schema='orchestrator')
    op.create_foreign_key(None, 'data_source_context', 'chat_context', ['context_id'], [
                          'id'], source_schema='orchestrator', referent_schema='orchestrator')
    op.create_foreign_key(None, 'dataset_context', 'chat_context', ['context_id'], [
                          'id'], source_schema='orchestrator', referent_schema='orchestrator')

    op.add_column('data_integration_run_result', sa.Column(
        'created_at', sa.DateTime(timezone=True), nullable=False), schema='runs')
    op.add_column('run', sa.Column('conversation_id',
                  sa.UUID(), nullable=False), schema='runs')
    op.create_foreign_key(None, 'run', 'conversation', ['conversation_id'], [
                          'id'], source_schema='runs', referent_schema='orchestrator')
    # ### end Alembic commands ###


def downgrade() -> None:
    # ### commands auto generated by Alembic - please adjust! ###
    op.drop_constraint(None, 'run', schema='runs', type_='foreignkey')
    op.drop_column('run', 'conversation_id', schema='runs')
    op.drop_column('data_integration_run_result', 'created_at', schema='runs')
    op.drop_constraint(None, 'dataset_context',
                       schema='orchestrator', type_='foreignkey')
    op.create_foreign_key('dataset_context_context_id_fkey', 'dataset_context', 'context', [
                          'context_id'], ['id'], source_schema='orchestrator', referent_schema='orchestrator')
    op.drop_constraint(None, 'data_source_context',
                       schema='orchestrator', type_='foreignkey')
    op.create_foreign_key('data_source_context_context_id_fkey', 'data_source_context', 'context', [
                          'context_id'], ['id'], source_schema='orchestrator', referent_schema='orchestrator')
    op.drop_constraint(None, 'chat_message',
                       schema='orchestrator', type_='foreignkey')
    op.create_foreign_key('chat_message_context_id_fkey', 'chat_message', 'context', [
                          'context_id'], ['id'], source_schema='orchestrator', referent_schema='orchestrator')
    op.drop_constraint(None, 'automation_context',
                       schema='orchestrator', type_='foreignkey')
    op.create_foreign_key('automation_context_context_id_fkey', 'automation_context', 'context', [
                          'context_id'], ['id'], source_schema='orchestrator', referent_schema='orchestrator')
    op.drop_constraint(None, 'analysis_context',
                       schema='orchestrator', type_='foreignkey')
    op.create_foreign_key('analysis_context_context_id_fkey', 'analysis_context', 'context', [
                          'context_id'], ['id'], source_schema='orchestrator', referent_schema='orchestrator')
    op.create_table('context',
                    sa.Column('id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.PrimaryKeyConstraint('id', name='context_pkey'),
                    schema='orchestrator',
                    postgresql_ignore_search_path=False
                    )
    op.create_table('run_in_conversation',
                    sa.Column('conversation_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('run_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('context_id', sa.UUID(),
                              autoincrement=False, nullable=False),
                    sa.Column('created_at', postgresql.TIMESTAMP(
                        timezone=True), autoincrement=False, nullable=False),
                    sa.ForeignKeyConstraint(['context_id'], [
                        'orchestrator.context.id'], name='run_in_conversation_context_id_fkey'),
                    sa.ForeignKeyConstraint(['conversation_id'], [
                        'orchestrator.conversation.id'], name='run_in_conversation_conversation_id_fkey'),
                    sa.ForeignKeyConstraint(
                        ['run_id'], ['runs.run.id'], name='run_in_conversation_run_id_fkey'),
                    sa.PrimaryKeyConstraint(
                        'conversation_id', 'run_id', name='run_in_conversation_pkey'),
                    schema='orchestrator'
                    )
    op.drop_table('chat_context', schema='orchestrator')
    # ### end Alembic commands ###
